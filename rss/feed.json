{
    "version": "https://jsonfeed.org/version/1",
    "title": "Le1a的菜园坝 ",
    "home_page_url": "https://www.le1a.me//",
    "description": "一个NotionNext搭建的博客",
    "author": {
        "name": "Le1a",
        "url": "https://www.le1a.me/"
    },
    "items": [
        {
            "content_html": "<div id=\"notion-article\" class=\"mx-auto overflow-hidden \"><main class=\"notion light-mode notion-page notion-block-15e7c0311dd68029b386db6142b650cf\"><div class=\"notion-viewport\"></div><div class=\"notion-collection-page-properties\"></div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-15e7c0311dd680a99ea4c8ec36a7b395\" data-id=\"15e7c0311dd680a99ea4c8ec36a7b395\"><span><div id=\"15e7c0311dd680a99ea4c8ec36a7b395\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#15e7c0311dd680a99ea4c8ec36a7b395\" title=\"漏洞描述\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞描述</b></span></span></h2><div class=\"notion-text notion-block-15e7c0311dd68065a4a3ca722be2b374\">Apache Struts2 是一个开源的 Java Web 应用程序开发框架，旨在帮助开发人员构建灵活、可维护和可扩展的企业级Web应用程序。近日，微步漏洞团队监测到官方披露 CVE-2023-50164 Apache Struts 文件上传漏洞。经过分析和研判，该漏洞利用难度低，攻击者可以通过污染相关上传参数导致目录遍历，在具体代码环境中可能导致上传 Webshell，执行任意代码，建议尽快修复。</div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-15e7c0311dd68036aa32c606f431779a\" data-id=\"15e7c0311dd68036aa32c606f431779a\"><span><div id=\"15e7c0311dd68036aa32c606f431779a\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#15e7c0311dd68036aa32c606f431779a\" title=\"漏洞分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞分析</b></span></span></h2><div class=\"notion-text notion-block-15e7c0311dd68096838ff29349c27843\">Struts2的默认配置通常包含<code class=\"notion-inline-code\">FileUploadInterceptor</code>，该拦截器负责处理文件上传，并将文件信息封装到相应的Action属性中。</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-15e7c0311dd680c5bfc9eeb9e1a0c08d\" data-id=\"15e7c0311dd680c5bfc9eeb9e1a0c08d\"><span><div id=\"15e7c0311dd680c5bfc9eeb9e1a0c08d\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#15e7c0311dd680c5bfc9eeb9e1a0c08d\" title=\"正常文件上传\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>正常文件上传</b></span></span></h3><div class=\"notion-text notion-block-15e7c0311dd680279bf6f5d1cfc1c264\">当我们使用默认配置上传文件，尝试路径穿越将文件上传至任意目录，测试发现无法路径穿越到任意目录</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd68006a1ced0c6f3f98ff6\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fa4233115-ee72-4e11-a84c-f25e693c6a4d%2Fec9c9e7daed0347e331a86ac08564b17.png?table=block&amp;id=15e7c031-1dd6-8006-a1ce-d0c6f3f98ff6&amp;t=15e7c031-1dd6-8006-a1ce-d0c6f3f98ff6&amp;width=692.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd68031a56ce7f9f8aed586\">我们在<code class=\"notion-inline-code\">FileUploadInterceptor#intercept()</code>打下断点，跟进代码</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680c78b43f95b43f41d2f\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fe399b184-abdd-411d-a170-8f1b4b96b589%2Fimage.png?table=block&amp;id=15e7c031-1dd6-80c7-8b43-f95b43f41d2f&amp;t=15e7c031-1dd6-80c7-8b43-f95b43f41d2f&amp;width=692.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd6807485e1f77413e04ee6\">这里跟进<code class=\"notion-inline-code\">multiWrapper.getFileNames()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680b4af75d1b062e0d1f4\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Ff4f20e40-d64f-4738-8a10-13c5c3894035%2Fimage.png?table=block&amp;id=15e7c031-1dd6-80b4-af75-d1b062e0d1f4&amp;t=15e7c031-1dd6-80b4-af75-d1b062e0d1f4&amp;width=2152&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd6807da507c20224ddd565\">这里继续跟进<code class=\"notion-inline-code\">getCanonicalName()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680918dd7d28c5c10987f\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F7b9bcde8-352f-4e6a-a713-085f43ab2fcc%2F6d0f9c2fc23d17fe158dffc8b4049f80.png?table=block&amp;id=15e7c031-1dd6-8091-8dd7-d28c5c10987f&amp;t=15e7c031-1dd6-8091-8dd7-d28c5c10987f&amp;width=2204&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd68092b3c9d6a43b13426e\">发现获取文件名是通过substring方法进行截取的，通过../../进行目录穿越是不行的。</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-15e7c0311dd68028903ef5311bf87889\" data-id=\"15e7c0311dd68028903ef5311bf87889\"><span><div id=\"15e7c0311dd68028903ef5311bf87889\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#15e7c0311dd68028903ef5311bf87889\" title=\"参数污染\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>参数污染</b></span></span></h3><div class=\"notion-text notion-block-15e7c0311dd680af9306c5b145868f95\">回到<code class=\"notion-inline-code\">FileUploadInterceptor#intercept()</code>中，在获取文件名后生成了两个变量<code class=\"notion-inline-code\">contentTypeName</code>和<code class=\"notion-inline-code\">fileNameName</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680c8af65fdaea268f039\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fb291eae3-f0b9-4fb0-aaeb-46fd8cd65d29%2F33c408a0d4f8890c56c299e057783c87.png?table=block&amp;id=15e7c031-1dd6-80c8-af65-fdaea268f039&amp;t=15e7c031-1dd6-80c8-af65-fdaea268f039&amp;width=692.9765625&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680a8b1e4f71790f91473\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fb214d3e2-6f34-49ce-9714-cdf6c9fc181b%2Fimage.png?table=block&amp;id=15e7c031-1dd6-80a8-b1e4-f71790f91473&amp;t=15e7c031-1dd6-80a8-b1e4-f71790f91473&amp;width=2320&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd6801fa954e16ce230b468\"><li>检查每一个文件是否可以被接受(根据配置规则检查,默认全部接受)</li></ol><ol start=\"2\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd68084aa7fe1b3a0a0aa20\"><li>对可以接受的文件,将其文件名、内容类型和文件内容分别保存到三个List中(acceptedFileNames、acceptedContentTypes和acceptedFiles)</li></ol><ol start=\"3\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd6806f9949e7cebd06d781\"><li>如果接受的文件列表不为空,则将这三个List分别封装成Parameter,并存入参数Map中:</li><ol class=\"notion-list notion-list-numbered notion-block-15e7c0311dd6806f9949e7cebd06d781\"><ul class=\"notion-list notion-list-disc notion-block-15e7c0311dd680eea366cbc9dbc64c15\"><li>文件内容列表acceptedFiles 封装成参数 inputName</li></ul><ul class=\"notion-list notion-list-disc notion-block-15e7c0311dd680b7983bc9bd324d78c0\"><li>内容类型列表 acceptedContentTypes 封装成参数 contentTypeName</li></ul><ul class=\"notion-list notion-list-disc notion-block-15e7c0311dd680e783d7ccf6711d3d8c\"><li>文件名列表 acceptedFileNames 封装成参数 fileNameName</li></ul></ol></ol><ol start=\"4\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd680588d06df413dc21074\"><li>最后将这个参数Map 设置到上下文的Parameters中，在<code class=\"notion-inline-code\">ParametersInterceptor#setParameters()</code>中对这些参数赋值</li></ol><div class=\"notion-text notion-block-15e7c0311dd68089adf3ca4474b3c5db\">跟进<code class=\"notion-inline-code\">ParametersInterceptor#setParameters()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680c1919ad9c8a3220941\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F5e69239c-1491-4701-ba36-0b78457037be%2Fimage.png?table=block&amp;id=15e7c031-1dd6-80c1-919a-d9c8a3220941&amp;t=15e7c031-1dd6-80c1-919a-d9c8a3220941&amp;width=692.9765625&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd6802097c2e8a49e6cd369\">这里采用<code class=\"notion-inline-code\">HttpParameters.create()</code>创建参数</div><div class=\"notion-text notion-block-15e7c0311dd680d9a219c54e6c9436ef\">而在新版本中，对HttpParameters做出了修改，变成了大小写不敏感，而在存在漏洞的版本中是大小写敏感的。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680c49d8acc0d3825a173\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F7fba75d4-4c8d-4301-b5b4-6693f22785cc%2Fimage.png?table=block&amp;id=15e7c031-1dd6-80c4-9d8a-cc0d3825a173&amp;t=15e7c031-1dd6-80c4-9d8a-cc0d3825a173&amp;width=692.9921875&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd680c28aeac5163dc90278\">这导致了这里FileFileName和fileFileName会是不同的参数，都会在<code class=\"notion-inline-code\">ParametersInterceptor#setParameters()</code>赋值</div><div class=\"notion-text notion-block-15e7c0311dd680feaa3dd46d07481874\">而后面采用了使用 OGNL 表达式调用 setter 方法对变量赋值</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd68091ae3edb358a22566f\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F8ef04ba5-f2c7-4e1d-bb89-61b087e5e5af%2F54fbd592be9b35aac7b0119859fcca97.png?table=block&amp;id=15e7c031-1dd6-8091-ae3e-db358a22566f&amp;t=15e7c031-1dd6-8091-ae3e-db358a22566f&amp;width=692.953125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-15e7c0311dd68096b73dc5a585c531a6\">OGNL 在查找 setter 方法时,会自动把属性名第一个字母变成大写,然后查找 setXxx() 这样的方法。</div><div class=\"notion-text notion-block-15e7c0311dd680da8c8ecd62bcf4447a\">例如,如果你有一个属性名为 &quot;name&quot;,那么 OGNL 会查找 setName() 方法。在这个过程中,不管 name 在 OGNL 表达式中是大写还是小写,都可以正确找到 setter 方法。所以在 Struts 2 的 OGNL 表达式中,属性名的首字母大小写可以不敏感。</div><div class=\"notion-text notion-block-15e7c0311dd680e3a7c2caea96fc8777\">所以当我手动传入一个fileFileName参数，在这里也会被赋值，fileFileName和FileFileName参数会被自动映射到同一个参数上。调用相应的get方法获取值时,会取得最后赋值的那个参数的值。</div><div class=\"notion-text notion-block-15e7c0311dd680c98dabee10559aea73\">那么这两个参数的赋值先后顺序呢？如果我们手动传入的参数会后赋值，就可以覆盖掉前面的参数，造成参数污染。</div><div class=\"notion-text notion-block-15e7c0311dd680198402e3dee41a6b8b\">在TreeMap中,键(key)的排序是大小写敏感的。默认的排序规则如下:</div><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd6807b825ce76b371f89cb\"><li>大写字母会排在小写字母之前</li></ol><ol start=\"2\" class=\"notion-list notion-list-numbered notion-block-15e7c0311dd6808ea277f774dff577b9\"><li>数字会排在字母之前</li></ol><div class=\"notion-text notion-block-15e7c0311dd68029a190c94e03817a5a\">所以当文件上传的name构造为大写开头，手动传入的污染参数构造为小写开头即可</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680ad832bd5ea80857d64\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F5a76b1c8-db45-426b-a806-99a12f0fd5a0%2Fd98de55d759ab6ff34c391c6d0f96048.png?table=block&amp;id=15e7c031-1dd6-80ad-832b-d5ea80857d64&amp;t=15e7c031-1dd6-80ad-832b-d5ea80857d64&amp;width=692.9765625&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-15e7c0311dd6800b8d2ce6b33c246975\" data-id=\"15e7c0311dd6800b8d2ce6b33c246975\"><span><div id=\"15e7c0311dd6800b8d2ce6b33c246975\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#15e7c0311dd6800b8d2ce6b33c246975\" title=\"漏洞复现\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞复现</b></span></span></h2><div class=\"notion-text notion-block-15e7c0311dd680439bf9deb7614197fa\">构造数据包：</div><div class=\"notion-text notion-block-15e7c0311dd680c68fc2e8876d3a9dc2\">文件上传成功，成功路径穿越到webapps目录下！</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-15e7c0311dd680ae833ff739f6972cd1\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6f84fd39-8400-4dbd-9f35-55789d298ed7%2Fc5100ec9719bf09d81af51e8a8ecd590.png?table=block&amp;id=15e7c031-1dd6-80ae-833f-f739f6972cd1&amp;t=15e7c031-1dd6-80ae-833f-f739f6972cd1&amp;width=692.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure></main></div>",
            "url": "https://www.le1a.me//article/s2-066",
            "title": "Apache Struts2 文件上传分析(S2-066)",
            "date_modified": "2023-12-10T00:00:00.000Z"
        },
        {
            "content_html": "<div id=\"notion-article\" class=\"mx-auto overflow-hidden \"><main class=\"notion light-mode notion-page notion-block-adf19a59b4604a129f59c06b2d1a7a5c\"><div class=\"notion-viewport\"></div><div class=\"notion-collection-page-properties\"></div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-0650a4e6d4924a1fa28a47ed96dbea3c\" data-id=\"0650a4e6d4924a1fa28a47ed96dbea3c\"><span><div id=\"0650a4e6d4924a1fa28a47ed96dbea3c\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#0650a4e6d4924a1fa28a47ed96dbea3c\" title=\"漏洞分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\">漏洞分析</span></span></h2><div class=\"notion-text notion-block-ca965b3773af451e916c7c75fac7fd64\">通过<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://www.weaver.com.cn/cs/security/edm20240725_kdielfrovkewpiiuyrtewtw.html\">官网公告</a>可得知漏洞路径为：/wxclient/app/recruit/resume/addResume?fileElementld=aaa</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-93b4e17e119944baada29915ee7046de\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:629px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fa7c6a4e7-3bd9-4ea7-be7f-85e53e8d8b1d%2FUntitled.png?table=block&amp;id=93b4e17e-1199-44ba-ada2-9915ee7046de&amp;t=93b4e17e-1199-44ba-ada2-9915ee7046de&amp;width=629&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-c49caa6c55704e5aa28ac3d2c5cf08bb\">根据路径可以很快定位到漏洞点为：<code class=\"notion-inline-code\">weaver.weixin.app.recruit.controller.ResumeController#addResume()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-59ac0beace184ac09c57083b1671f334\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fc3f4fb28-ead3-4911-b308-bd708fa8dd26%2FUntitled.png?table=block&amp;id=59ac0bea-ce18-4ac0-9c57-083b1671f334&amp;t=59ac0bea-ce18-4ac0-9c57-083b1671f334&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-b3b84047dd544f1c9477d6472dba2cf7\">跟进<code class=\"notion-inline-code\">getWxBaseFile()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1bbbdba737c54627bd446a54f1a68406\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Ff09ba98e-a981-4184-9b1b-447c3ff23ada%2FUntitled.png?table=block&amp;id=1bbbdba7-37c5-4627-bd44-6a54f1a68406&amp;t=1bbbdba7-37c5-4627-bd44-6a54f1a68406&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-624558025ab444c2a3e9280e0d0c1e31\">这里因为显式传入的filepath为空，所以进入<code class=\"notion-inline-code\">FileUploadTools.getRandomFilePath()</code></div><div class=\"notion-text notion-block-d411e90f83114b33b7162052ed2e234c\">这里尝试通过GCONST.getFileRootPath()获取缓存目录，如果不存在，则获取Web根目录。</div><div class=\"notion-text notion-block-a245e9025238411db65cd60b22eb9c7e\">所以这里构造的_filePath为<code class=\"notion-inline-code\">/upload/年月/随机2位大写字母/</code></div><div class=\"notion-text notion-block-b46c18f0a08645c09dfcb1dc91217518\">继续跟进<code class=\"notion-inline-code\">uf = this.getFile(parameterName, _filePath, _fileMaxSize, _fileEncoding);</code></div><div class=\"notion-text notion-block-5d9e185356484c58bd28e50e3ca9f0d8\">在getFiles()中，判断检查当前request是否为MultipartRequest类型，如果不是,则将其包装成MultipartRequest，MultipartRequest会处理文件上传,将文件保存到指定目录</div><div class=\"notion-text notion-block-93ac7dfa97474de395dfefa53aa23cab\">使用 <code class=\"notion-inline-code\">MultipartRequest</code> 类处理多部分请求，并遍历所有上传的文件。</div><div class=\"notion-text notion-block-1244e144df9c475d9b1aa9f01c2b7446\">这里已经上传了文件了。后面的代码则主要是遍历上传的文件，并将其信息存储在 <code class=\"notion-inline-code\">UploadFile</code> 对象中，构造一个上传文件的列表</div><ul class=\"notion-list notion-list-disc notion-block-71f8261128324a50af36115c648e1132\"><li>获取文件名、文件系统名、原始文件名和内容类型。</li></ul><ul class=\"notion-list notion-list-disc notion-block-217c1753fb604dbdbc46616193863456\"><li>创建 <code class=\"notion-inline-code\">UploadFile</code> 对象。</li></ul><ul class=\"notion-list notion-list-disc notion-block-d5d30798645e43f18bed9d160da00c27\"><li>检查文件是否安全，若安全则添加到上传文件列表。</li></ul><div class=\"notion-text notion-block-5c1bdd0ca5af4449be45b4a95910be79\">这里重点关注isSafeFile()函数</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-e9b187e7134145a8b4d2a73c40fd48cb\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:603px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fa10812f2-cf3c-4064-9ce9-b47ebb8a2666%2FUntitled.png?table=block&amp;id=e9b187e7-1341-45a8-b4d2-a73c40fd48cb&amp;t=e9b187e7-1341-45a8-b4d2-a73c40fd48cb&amp;width=603&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-44767d3bed854be6ac5eeeb679918600\">如果上传的文件以jsp结尾，则会把刚刚已经上传成功的对象删掉。虽然理论上可以条件竞争，但路径还需要爆破2位大写字符，估计很难实现。</div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-e4a79d15ec07484ebca1caa90103d8fe\" data-id=\"e4a79d15ec07484ebca1caa90103d8fe\"><span><div id=\"e4a79d15ec07484ebca1caa90103d8fe\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#e4a79d15ec07484ebca1caa90103d8fe\" title=\"绕过isSafeFile\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\">绕过isSafeFile</span></span></h2><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-d04f26a8ea034c16bcb625ea351e5d3b\" data-id=\"d04f26a8ea034c16bcb625ea351e5d3b\"><span><div id=\"d04f26a8ea034c16bcb625ea351e5d3b\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#d04f26a8ea034c16bcb625ea351e5d3b\" title=\"方法一\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\">方法一</span></span></h3><div class=\"notion-text notion-block-ef56c5c1a81847dca4df7d2b7f8430b7\">这里禁止了jsp，但是没有禁止jspx，所以可以上传jspx绕过</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-b6f5a77be1054fa1872d5ea4fa0b5b1a\" data-id=\"b6f5a77be1054fa1872d5ea4fa0b5b1a\"><span><div id=\"b6f5a77be1054fa1872d5ea4fa0b5b1a\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#b6f5a77be1054fa1872d5ea4fa0b5b1a\" title=\"方法二\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\">方法二</span></span></h3><div class=\"notion-text notion-block-594dcd4fb9a340fcb7000fc1affb9ac1\">仔细观察代码不难发现，传入isSafeFile函数的uploadfile对象的name来源于<code class=\"notion-inline-code\">this.multipartRequest.getFilesystemName(name);</code></div><div class=\"notion-text notion-block-410c57187d7943c4ac6b7733d42be323\"><code class=\"notion-inline-code\">this.multipartRequest.getFilesystemName(name)</code> 只会获取 <code class=\"notion-inline-code\">name</code> 对应的最后一个文件的文件名，因为 <code class=\"notion-inline-code\">files.get(name)</code> 返回的是与 <code class=\"notion-inline-code\">name</code> 关联的最后一个 <code class=\"notion-inline-code\">UploadedFile</code> 对象。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-5319663a8b79489781193b20d872526f\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:576px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Ff6227ace-b426-4577-a116-daa5eb4c5e5d%2FUntitled.png?table=block&amp;id=5319663a-8b79-4897-8119-3b20d872526f&amp;t=5319663a-8b79-4897-8119-3b20d872526f&amp;width=576&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-f85ded2cefd4497e99ef7ccab402299b\">这是因为 <code class=\"notion-inline-code\">MultipartRequest</code> 内部存储文件的方式是基于一个哈希表，其中键是表单字段的名称（<code class=\"notion-inline-code\">name</code>），而值是 <code class=\"notion-inline-code\">UploadedFile</code> 对象。</div><div class=\"notion-text notion-block-711e3fe0345145f4a872eed8cf7271d2\">在这种情况下，如果表单中有多个文件输入域具有相同的名称，后续的文件会覆盖之前的文件，导致哈希表中仅保留最后一个文件。</div><div class=\"notion-text notion-block-924553818db445bfbacd7cab39c7243a\"><b>详细解释</b></div><div class=\"notion-text notion-block-6f950548e6834bca9c43c9ea2260ee00\">假设表单上传了两个文件，两个文件的表单字段名称都叫 <code class=\"notion-inline-code\">file</code>。当 <code class=\"notion-inline-code\">MultipartRequest</code> 处理这些文件时：</div><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-5cd82b405e814eaab1c6c64c4ba61e39\"><li>第一个文件 <code class=\"notion-inline-code\">file</code> 被添加到哈希表中，键为 <code class=\"notion-inline-code\">file</code>，值为第一个 <code class=\"notion-inline-code\">UploadedFile</code> 对象。</li></ol><ol start=\"2\" class=\"notion-list notion-list-numbered notion-block-9cfd3a77b84d4f25bb76f083c8efd6de\"><li>第二个文件 <code class=\"notion-inline-code\">file</code> 也被添加到哈希表中，键仍然为 <code class=\"notion-inline-code\">file</code>，值为第二个 <code class=\"notion-inline-code\">UploadedFile</code> 对象。</li></ol><div class=\"notion-text notion-block-ad98985a194e4455a761e9a21cd460b9\">由于哈希表中的键是唯一的，因此第二个文件会覆盖第一个文件的值。</div><div class=\"notion-text notion-block-10e5c727a7764ed9ae74684378a81e6c\">所以构造如下表单即可绕过</div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-31a925870227494aaea4bf79794ad18b\" data-id=\"31a925870227494aaea4bf79794ad18b\"><span><div id=\"31a925870227494aaea4bf79794ad18b\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#31a925870227494aaea4bf79794ad18b\" title=\"绕过jfinal\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\">绕过jfinal</span></span></h2><div class=\"notion-text notion-block-3182e36d487c4101bd87d4be84c182e7\">由于jfinal的限制，导致不能直接访问jsp文件</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-2411154f7f6c4258a540128aa5222dc5\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:673px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fbd1fcd0c-b99a-42cf-abb2-0526791575b9%2FUntitled.png?table=block&amp;id=2411154f-7f6c-4258-a540-128aa5222dc5&amp;t=2411154f-7f6c-4258-a540-128aa5222dc5&amp;width=673&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-80dd155fd38d494f83398153fc389ce1\">通过这篇文章的姿势：<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://forum.butian.net/share/1899\">https://forum.butian.net/share/1899</a>\n使用request.getRequestURI()这两个方法进行访问path的获取时，是不会进行URL解码操作的，利用这一点同样可以进行Bypass</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-a87567b9246745678bf4b91317c9b895\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Feb2483c3-d891-4da0-a73a-499ef3b6996d%2FUntitled.png?table=block&amp;id=a87567b9-2467-4567-8bf4-b91317c9b895&amp;t=a87567b9-2467-4567-8bf4-b91317c9b895&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure></main></div>",
            "url": "https://www.le1a.me//article/e-Bridge",
            "title": "泛微云桥e-Bridge文件上传漏洞分析",
            "date_modified": "2024-07-27T16:00:00.000Z"
        },
        {
            "content_html": "<div id=\"notion-article\" class=\"mx-auto overflow-hidden \"><main class=\"notion light-mode notion-page notion-block-1317c0311dd6805bb1a8e107ec9094f6\"><div class=\"notion-viewport\"></div><div class=\"notion-collection-page-properties\"></div><div class=\"notion-text notion-block-1317c0311dd680cb8991d09aac605f8a\">文章首发自<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://forum.butian.net/share/2741\">奇安信攻防社区</a></div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-1317c0311dd68036a4f5c5942825e3b5\" data-id=\"1317c0311dd68036a4f5c5942825e3b5\"><span><div id=\"1317c0311dd68036a4f5c5942825e3b5\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#1317c0311dd68036a4f5c5942825e3b5\" title=\"漏洞分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞分析</b></span></span></h2><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd68040b925db0899a1dbc1\" data-id=\"1317c0311dd68040b925db0899a1dbc1\"><span><div id=\"1317c0311dd68040b925db0899a1dbc1\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#1317c0311dd68040b925db0899a1dbc1\" title=\"漏洞原理\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞原理</b></span></span></h3><div class=\"notion-text notion-block-1317c0311dd680baadd3ea89a1ba3604\">在Confluence中，.vm文件是使用Velocity模板语言创建的模板文件。Velocity是一个基于Java的模板引擎，它允许你使用简单的标记语言来引用Java对象和方法，从而动态生成HTML、XML或任何文本格式的内容。</div><div class=\"notion-text notion-block-1317c0311dd6806eb9c0ee817c023dc6\">处理.vm文件的主要类是ConfluenceVelocityServlet。这个Servlet负责接收和处理来自浏览器的请求，加载和解析.vm模板，执行其中的Velocity代码，然后将生成的HTML发送回浏览器。</div><div class=\"notion-text notion-block-1317c0311dd6804b9171f54ebb54c0e5\">这次的漏洞点位于：/template/aui/text-inline.vm文件，可以直接通过/template/aui/text-inline.vm访问</div><div class=\"notion-text notion-block-1317c0311dd68078b88bcb822eea9003\"><code class=\"notion-inline-code\">$stack.findValue(&quot;getText(&#x27;$parameters.label&#x27;)&quot;)</code>意味着从请求中获取的label参数的值传入了<code class=\"notion-inline-code\">$stack.findValue</code>，由此可以判断这里存在模版注入！</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd680a09a5bfc7bfd204618\" data-id=\"1317c0311dd680a09a5bfc7bfd204618\"><span><div id=\"1317c0311dd680a09a5bfc7bfd204618\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#1317c0311dd680a09a5bfc7bfd204618\" title=\"调用分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>调用分析</b></span></span></h3><div class=\"notion-text notion-block-1317c0311dd68001b4cfc1dc454c9d2e\">.vm文件由<code class=\"notion-inline-code\">ConfluenceVelocityServlet</code>处理</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680ea97bcc2c2790a2d30\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F99db354f-26d5-4d3b-b6c6-81dc2342be1a%2Fe22f77c1549f4aa6b310ec5d33c8de0d.png?table=block&amp;id=1317c031-1dd6-80ea-97bc-c2c2790a2d30&amp;t=1317c031-1dd6-80ea-97bc-c2c2790a2d30&amp;width=707.828125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd680dd9a22c3af55075a54\">继续跟进</div><div class=\"notion-text notion-block-1317c0311dd680968981fc03472fdf98\">这里跟进<code class=\"notion-inline-code\">handleRequest()</code>，可以发现从URI中获取vm文件路径，传入<code class=\"notion-inline-code\">getTemplate()</code>来返回模版对象</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68024b385cc3b822698f9\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F993515ab-4052-49a5-aed3-797a9633dd17%2Fimage.png?table=block&amp;id=1317c031-1dd6-8024-b385-cc3b822698f9&amp;t=1317c031-1dd6-8024-b385-cc3b822698f9&amp;width=707.96875&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd6800bb885f23d6640a32b\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F15b87c5a-4b6a-436c-8310-f67a666781fc%2F97a75a2c0bfa0e50a7cd60d0233d754e.png?table=block&amp;id=1317c031-1dd6-800b-b885-f23d6640a32b&amp;t=1317c031-1dd6-800b-b885-f23d6640a32b&amp;width=707.84375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd6801b9e66c5989b10b8ef\">然后传入<code class=\"notion-inline-code\">mergeTemplate()</code>函数处理</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd6801eb7dbf3d4fa01d0b7\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fb30aeefa-7b83-4f46-b71a-6cdc4fc7e59d%2Fimage.png?table=block&amp;id=1317c031-1dd6-801e-b7db-f3d4fa01d0b7&amp;t=1317c031-1dd6-801e-b7db-f3d4fa01d0b7&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd680d287b3e7eb23987e6d\">这里创建新的PageContext，获取其输出流，准备进行模板合并和输出操作。</div><div class=\"notion-text notion-block-1317c0311dd68024a25bd65239f0fe00\">继续跟进<code class=\"notion-inline-code\">template.merge()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680e19f43e1fbb1a9fead\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fc4c74208-bc44-4e91-aa24-29f6e26bb8d5%2Fimage.png?table=block&amp;id=1317c031-1dd6-80e1-9f43-e1fbb1a9fead&amp;t=1317c031-1dd6-80e1-9f43-e1fbb1a9fead&amp;width=707.828125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd6807e986ddaa9487ab078\">跟进到merge的重载函数</div><div class=\"notion-text notion-block-1317c0311dd680f08ebeecd435b86cb5\">由于传入的macroLibraries为空，所以直接执行try逻辑</div><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-1317c0311dd68081ab39ea77aaf744b9\"><li>调用 <code class=\"notion-inline-code\">ica.pushCurrentTemplateName(this.name);</code> 将当前模板的名称压入到 <code class=\"notion-inline-code\">ica</code> 的模板名堆栈中。这是为了在嵌套模板的情况下能够追踪到当前正在处理的模板名称。</li></ol><ol start=\"2\" class=\"notion-list notion-list-numbered notion-block-1317c0311dd680f5bf8dc3bf7c370d2e\"><li>调用 <code class=\"notion-inline-code\">ica.setCurrentResource(this);</code> 将当前模板对象设置为 <code class=\"notion-inline-code\">ica</code> 的当前资源。这是为了让 <code class=\"notion-inline-code\">ica</code> 知道当前正在处理的模板资源。</li></ol><ol start=\"3\" class=\"notion-list notion-list-numbered notion-block-1317c0311dd680d3b8c9c771ac2d6331\"><li>最后，通过调用 <code class=\"notion-inline-code\">((SimpleNode)this.data).render(ica, writer);</code> 进行模板渲染</li></ol><div class=\"notion-text notion-block-1317c0311dd680fbb80ac1266ce4fa51\">省略中间的部分渲染过程，跟进到<code class=\"notion-inline-code\">ASTReference#execute()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680cb9c24f95f4fa2e7b9\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F5e740428-8285-4aeb-9958-6f02563498e1%2Fimage.png?table=block&amp;id=1317c031-1dd6-80cb-9c24-f95f4fa2e7b9&amp;t=1317c031-1dd6-80cb-9c24-f95f4fa2e7b9&amp;width=707.953125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd680388acbf473e685d746\">这里从上下文中获取OgnlValueStack，继续跟进</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68019865bfa6d8ead0ea2\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F44225b74-de09-4018-b27f-277590603a3a%2F690287b645ae33dfc462717e50a1d0cf.png?table=block&amp;id=1317c031-1dd6-8019-865b-fa6d8ead0ea2&amp;t=1317c031-1dd6-8019-865b-fa6d8ead0ea2&amp;width=707.953125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68059b12df7d53b88ff34\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6fe3bec0-d754-4d8a-9538-60dc91f11021%2F544288fb70d17ceafa3f06389f68cd6c.png?table=block&amp;id=1317c031-1dd6-8059-b12d-f7d53b88ff34&amp;t=1317c031-1dd6-8059-b12d-f7d53b88ff34&amp;width=707.90625&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd68070b2ecc60ce5c07432\">这里从请求中获取到参数，然后通过<code class=\"notion-inline-code\">Object obj = method.invoke(o, params);</code>执行，继续跟进</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680179a32efa5220908ea\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F9c358602-f3bf-464f-bdeb-89c067d77175%2Fed5c01b18467688afa915ea3c790f2bd.png?table=block&amp;id=1317c031-1dd6-8017-9a32-efa5220908ea&amp;t=1317c031-1dd6-8017-9a32-efa5220908ea&amp;width=707.921875&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd68057ba86e8e210f39003\">经过几层invoke调用后，来到了最终vm文件模版的位置——<code class=\"notion-inline-code\">OgnlValueStack.findValue()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680fab583f4d3532af4c3\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fbf23f16f-d827-4550-b52a-4780c209c59c%2F6c71d0aace93017b4bacb4d4ecf292b1.png?table=block&amp;id=1317c031-1dd6-80fa-b583-f4d3532af4c3&amp;t=1317c031-1dd6-80fa-b583-f4d3532af4c3&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-1317c0311dd68075838bc71ab561654a\">随后，传给label参数的OGNL表达式语句被执行</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680118768d61d5e7ee02c\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:650px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6bf97707-7247-4990-b53c-ea2448e33da0%2F4d1a9301a88dd689252d23be73a0cec0.png?table=block&amp;id=1317c031-1dd6-8011-8768-d61d5e7ee02c&amp;t=1317c031-1dd6-8011-8768-d61d5e7ee02c&amp;width=650&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd6802cbec3e2f328819293\" data-id=\"1317c0311dd6802cbec3e2f328819293\"><span><div id=\"1317c0311dd6802cbec3e2f328819293\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#1317c0311dd6802cbec3e2f328819293\" title=\"绕过沙箱RCE\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>绕过沙箱RCE</b></span></span></h3><div class=\"notion-text notion-block-1317c0311dd68020ba60e18d17f7a34a\">由这篇文章可得知：<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context\">https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context</a></div><div class=\"notion-text notion-block-1317c0311dd680159521d4a28672528f\">对于Velocity模版引擎，可以使用如下方法：</div><ul class=\"notion-list notion-list-disc notion-block-1317c0311dd680c9a718df7f30fd355f\"><li><code class=\"notion-inline-code\">.KEY_velocity.struts2.context</code> -&gt; (<code class=\"notion-inline-code\">StrutsVelocityContext</code>)</li><ul class=\"notion-list notion-list-disc notion-block-1317c0311dd680c9a718df7f30fd355f\"><li><code class=\"notion-inline-code\">ognl</code> (<code class=\"notion-inline-code\">org.apache.struts2.views.jsp.ui.OgnlTool</code>)</li><li><code class=\"notion-inline-code\">struts</code> (<code class=\"notion-inline-code\">org.apache.struts2.views.velocity.result.VelocityStrutsUtils</code>)</li></ul></ul><div class=\"notion-text notion-block-1317c0311dd68070b21de82586e09219\">org.apache.struts2.views.jsp.ui.OgnlTool 类在没有 OgnlContext 的情况下调用了 Ognl.getValue()。需要注意的是，该类属于 OGNL 库，而不是 Struts 的一部分。因此，这个&quot;findValue&quot;调用在 Struts 的沙箱限制之外运行。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68098a508fbafe0734710\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F754b5e1b-0658-44aa-b487-8f98f30cfbfd%2F5473a8f4ae2a8e00f10d22368c6b5699.png?table=block&amp;id=1317c031-1dd6-8098-a508-fbafe0734710&amp;t=1317c031-1dd6-8098-a508-fbafe0734710&amp;width=2538&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-1317c0311dd68009a095fdb5b1b6e980\" data-id=\"1317c0311dd68009a095fdb5b1b6e980\"><span><div id=\"1317c0311dd68009a095fdb5b1b6e980\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#1317c0311dd68009a095fdb5b1b6e980\" title=\"漏洞复现\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞复现</b></span></span></h2><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-1317c0311dd68099b128d561d5c03e82\"><li>网站首页如下图：</li></ol><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68015856eea9e4e0b9c4c\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F4df4b43f-dbfb-419f-9b3a-aa9bcc81d496%2F073dda6525265eb10056a37ca253689a.png?table=block&amp;id=1317c031-1dd6-8015-856e-ea9e4e0b9c4c&amp;t=1317c031-1dd6-8015-856e-ea9e4e0b9c4c&amp;width=3004&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><ol start=\"1\" class=\"notion-list notion-list-numbered notion-block-1317c0311dd680d4b24fd1bfb68fefd4\"><li>使用如下POC进行漏洞复现</li></ol><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680fb8577f6c4cd8b2472\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F71a4d1a0-832b-4558-a3ab-8f3e5d1debd6%2Fimage.png?table=block&amp;id=1317c031-1dd6-80fb-8577-f6c4cd8b2472&amp;t=1317c031-1dd6-80fb-8577-f6c4cd8b2472&amp;width=2822&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure></main></div>",
            "url": "https://www.le1a.me//article/confluence-velocity",
            "title": "Atlassian Confluence 模板注入漏洞（CVE-2023-22527）",
            "date_modified": "2024-01-21T16:00:00.000Z"
        },
        {
            "content_html": "该文章需要密码才能查看！",
            "url": "https://www.le1a.me//article/zentao-sql-to-rce",
            "title": "禅道二次SQL注入到RCE漏洞分析",
            "summary": "该文章需要密码才能查看！",
            "date_modified": "2024-09-02T16:00:00.000Z"
        },
        {
            "content_html": "<div id=\"notion-article\" class=\"mx-auto overflow-hidden \"><main class=\"notion light-mode notion-page notion-block-7fe183095ae841c3b999d9305725f8eb\"><div class=\"notion-viewport\"></div><div class=\"notion-collection-page-properties\"></div><div class=\"notion-text notion-block-6ca1e7b149cf4063a0f172824def6ace\">文章首发自<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://xz.aliyun.com/t/15402\">先知社区</a></div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-60d820e58c3940318ed8369c260b3e71\" data-id=\"60d820e58c3940318ed8369c260b3e71\"><span><div id=\"60d820e58c3940318ed8369c260b3e71\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#60d820e58c3940318ed8369c260b3e71\" title=\"漏洞分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞分析</b></span></span></h2><div class=\"notion-text notion-block-2d2af69af9f74abea597a10b3cb62754\">这个漏洞是一个前台身份验证绕过加上后台JDBC注入的组合漏洞。首先来分析一下这个身份验证绕过漏洞。</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-563bfced9a1f4b18948f4e23e7fcd21f\" data-id=\"563bfced9a1f4b18948f4e23e7fcd21f\"><span><div id=\"563bfced9a1f4b18948f4e23e7fcd21f\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#563bfced9a1f4b18948f4e23e7fcd21f\" title=\"serviceTicketId\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>serviceTicketId</b></span></span></h3><div class=\"notion-text notion-block-c7d549b41ddd437a8c4953b4dc81ed19\">漏洞代码位于<code class=\"notion-inline-code\">com.weaver.passport.controller.RestLoginController#appThirdLogin()</code></div><div class=\"notion-text notion-block-74915fe9c201469eac3f28c68f059d2a\">跟进到</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-0deb768c9dff49489735534f4a6e12d5\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F56382abb-16f6-4320-95b6-7cab3887ef53%2Fimage.png?table=block&amp;id=0deb768c-9dff-4948-9735-534f4a6e12d5&amp;t=0deb768c-9dff-4948-9735-534f4a6e12d5&amp;width=693&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-612cfa46c774489890d5bd4f7d23f281\">该方法会根据传入的<code class=\"notion-inline-code\">loginType</code>参数获取对应的<code class=\"notion-inline-code\">CasLoginEnum</code>。如果当前没有可用的票据(ticket),则会使用传入的<code class=\"notion-inline-code\">username</code>创建一个新的<code class=\"notion-inline-code\">TicketGrantingTicket</code>。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-1a80486fa4564ca08d53fe06e354b682\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fe32149ad-d14b-4d68-8789-f9d4e1bb1533%2Fimage_(1).png?table=block&amp;id=1a80486f-a456-4ca0-8d53-fe06e354b682&amp;t=1a80486f-a456-4ca0-8d53-fe06e354b682&amp;width=707.953125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-3a5e7dc6dd7e446d93cbbdda138e0a75\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F477ae9b2-8140-4a21-8929-e9293ba101b7%2Fimage_(2).png?table=block&amp;id=3a5e7dc6-dd7e-446d-93cb-bdda138e0a75&amp;t=3a5e7dc6-dd7e-446d-93cb-bdda138e0a75&amp;width=707.953125&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-181137db85844fccbb36f2b1e054eb68\">在<code class=\"notion-inline-code\">authenticateInternal</code>方法中,会根据相应的条件获取用户的相关信息。</div><div class=\"notion-text notion-block-20b25b555a9243cf9ee9b4cca3da0f85\">最后在appThirdLogin中生成serviceTicketId</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-f14083af39f741239723b82a98cac39f\" data-id=\"f14083af39f741239723b82a98cac39f\"><span><div id=\"f14083af39f741239723b82a98cac39f\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#f14083af39f741239723b82a98cac39f\" title=\"EteamsId\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>EteamsId</b></span></span></h3><div class=\"notion-text notion-block-e52d65c36166415e93c6363a12998006\">在获取到 <code class=\"notion-inline-code\">serviceTicketId</code> 之后,可以通过调用 <code class=\"notion-inline-code\">PassportLoginController#generateEteamsId()</code> 方法来获取 <code class=\"notion-inline-code\">EteamsId</code>。</div><blockquote class=\"notion-quote notion-block-5e82ce152d104c889679952967fe21a4\"><div>在泛微 e-cology 10 中,EteamsId 是一种用于会话管理的机制,类似于其他 Web 应用程序中的 Session ID 或 Cookie。</div></blockquote><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-32a7fa8a7f9944f8ab3cd609ff12ec6e\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F1a348990-58d8-48f9-8a1b-8f3553452f6e%2Fimage_(3).png?table=block&amp;id=32a7fa8a-7f99-44f8-ab3c-d609ff12ec6e&amp;t=32a7fa8a-7f99-44f8-ab3c-d609ff12ec6e&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-9f79b414d5364552bd54fcd6af4a10cc\">这里返回了 <code class=\"notion-inline-code\">EteamsId</code>,它是通过将 <code class=\"notion-inline-code\">loginType</code> 和 <code class=\"notion-inline-code\">serviceTicketId</code> 的 MD5 值拼接而成的。在补丁中,已经无法通过该接口获取 <code class=\"notion-inline-code\">EteamsId</code> 了。\n不过,该代码给出了构造 <code class=\"notion-inline-code\">EteamsId</code> 的方式,最初我们以为可以手动伪造。但经过测试发现,这并不可行。原因是 <code class=\"notion-inline-code\">this.securityContextCache.put(tokenId, context)</code> 将 <code class=\"notion-inline-code\">EteamsId</code> 存储到了上下文环境中,而手动构造的 <code class=\"notion-inline-code\">EteamsId</code> 没有经历这一步,因此无法通过校验。</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-9e5ede8ee4dd48768013ac9e574adbcd\" data-id=\"9e5ede8ee4dd48768013ac9e574adbcd\"><span><div id=\"9e5ede8ee4dd48768013ac9e574adbcd\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#9e5ede8ee4dd48768013ac9e574adbcd\" title=\"JDBC Attack\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>JDBC Attack</b></span></span></h3><div class=\"notion-text notion-block-215a99eb6d6e4f6f8f48a86adae5cb22\">漏洞点在<code class=\"notion-inline-code\">DataConnController#testConnByBasePassword()</code></div><div class=\"notion-text notion-block-b323896720b94307b9ffe20a8ae04ac2\">跟进到<code class=\"notion-inline-code\">testConn()</code></div><div class=\"notion-text notion-block-09158a6c83c14cf69bb56188061e02f8\">继续跟进</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-880b527d839448e3a04d5d2acc2f5daf\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fdc62cffa-a82d-4874-8eaf-a2ed4cf457ba%2Fimage_(4).png?table=block&amp;id=880b527d-8394-48e3-a04d-5d2acc2f5daf&amp;t=880b527d-8394-48e3-a04d-5d2acc2f5daf&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-7b55722bd7f34440bd52780bf9b49b8b\">该方法会根据<code class=\"notion-inline-code\">DbType</code>参数来判断使用哪种数据库驱动。如果相应的驱动尚未加载,它还会通过反射的方式动态获取并实例化该驱动。随后,它会采用 JDK 自带的<code class=\"notion-inline-code\">DriverManager.getConnection()</code>方法建立数据库连接。这种方式不需要显式声明数据库驱动,而是由 JDBC URL 来决定使用哪种驱动,但前提是该驱动类已经被成功加载。</div><div class=\"notion-text notion-block-3a0aef11c2554ca1920a4c3cbcf6c375\">这里可以利用的点有很多，可以打mysql、db2等，但这两种都需要出网才能利用。</div><h4 class=\"notion-h notion-h3 notion-h-indent-2 notion-block-e5bd3fd776594efe950fdcb12d6c6cb2\" data-id=\"e5bd3fd776594efe950fdcb12d6c6cb2\"><span><div id=\"e5bd3fd776594efe950fdcb12d6c6cb2\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#e5bd3fd776594efe950fdcb12d6c6cb2\" title=\"mysql\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>mysql</b></span></span></h4><div class=\"notion-text notion-block-ab2b836f149f4f04ab5179ee721ef124\">这里存在 MySQL5.x版本，可以利用它来读取文件。同时,如果存在合适的反序列化漏洞链,也能RCE</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-3c7acfe10325429cbf89cb8f089182fc\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F0e735628-295c-42d1-b136-7bf16a61ad8d%2Fimage_(5).png?table=block&amp;id=3c7acfe1-0325-429c-bf89-cb8f089182fc&amp;t=3c7acfe1-0325-429c-bf89-cb8f089182fc&amp;width=693&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><h4 class=\"notion-h notion-h3 notion-h-indent-2 notion-block-c339cfb76a954c399eeff30c5387993c\" data-id=\"c339cfb76a954c399eeff30c5387993c\"><span><div id=\"c339cfb76a954c399eeff30c5387993c\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#c339cfb76a954c399eeff30c5387993c\" title=\"db2\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>db2</b></span></span></h4><div class=\"notion-text notion-block-82b04311a8c3448d82d2fdbadf19c878\">由于新版本 ec10 中使用的 JDK 版本为 8u201,因此需要借助<code class=\"notion-inline-code\">javax.el.ELProcessor#eval</code></div><div class=\"notion-text notion-block-ce35db9d1e184664ada3d290c4fd2fab\">方法来绕过一些限制。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-5e4ae8b5ee3e4bd9b7b3c2223c52ea69\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6e03c13a-abf1-4783-9668-a921cf904f30%2Fimage_(6).png?table=block&amp;id=5e4ae8b5-ee3e-4bd9-b7b3-c2223c52ea69&amp;t=5e4ae8b5-ee3e-4bd9-b7b3-c2223c52ea69&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-e1ace7871ed945958c36174cb7eb83e0\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F0029afa2-1bc0-4a0a-a988-2a28dbe4d55f%2Fimage_(7).png?table=block&amp;id=e1ace787-1ed9-4595-8c36-174cb7eb83e0&amp;t=e1ace787-1ed9-4595-8c36-174cb7eb83e0&amp;width=707.984375&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><h4 class=\"notion-h notion-h3 notion-h-indent-2 notion-block-3481c8744cab4899afc7cfb1098eb232\" data-id=\"3481c8744cab4899afc7cfb1098eb232\"><span><div id=\"3481c8744cab4899afc7cfb1098eb232\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#3481c8744cab4899afc7cfb1098eb232\" title=\"H2\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>H2</b></span></span></h4><div class=\"notion-text notion-block-f9dd82b85e0c42bb95f948d3d9d0fe81\">更加优雅的利用方式就是通过加载 H2 数据库驱动来实现无需出网的利用。虽然在当前的环境中无法直接加载 H2 驱动，但我们可以寻找其他的方法加载h2驱动：<code class=\"notion-inline-code\">IaAuthclientController#save()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-cca03c7238c74d20a2d539c597a54bcc\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fa40050d6-98ea-460f-ab94-b8b40842d125%2Fimage_(8).png?table=block&amp;id=cca03c72-38c7-4d20-a2d5-39c597a54bcc&amp;t=cca03c72-38c7-4d20-a2d5-39c597a54bcc&amp;width=707.96875&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-c745e941fb634a3294ca3aad7083cf84\">构造如下格式的数据包即可加载h2数据库驱动</div><div class=\"notion-text notion-block-b120e1c8138d4c308a62802754bef3dd\">此时我们就可以利用h2数据库执行任意Java代码了，这里dbType任意即可。</div><div class=\"notion-blank notion-block-7218b8a03335481b8cd651e530a9811d\"> </div></main></div>",
            "url": "https://www.le1a.me//article/weaver-e-cology-jdbc",
            "title": "泛微 e-cology 远程代码执行漏洞分析",
            "date_modified": "2024-09-02T16:00:00.000Z"
        },
        {
            "content_html": "<div id=\"notion-article\" class=\"mx-auto overflow-hidden \"><main class=\"notion light-mode notion-page notion-block-ecaa9d22cb914319a4ed94546d978306\"><div class=\"notion-viewport\"></div><div class=\"notion-collection-page-properties\"></div><div class=\"notion-text notion-block-3f69b0304d8847b89531b6ab6324c646\">文章首发自<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://xz.aliyun.com/t/15006\">先知社区</a></div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-5548d1f3d5ba4695aa6d42a1d4441cb1\" data-id=\"5548d1f3d5ba4695aa6d42a1d4441cb1\"><span><div id=\"5548d1f3d5ba4695aa6d42a1d4441cb1\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#5548d1f3d5ba4695aa6d42a1d4441cb1\" title=\"漏洞描述\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞描述</b></span></span></h2><div class=\"notion-text notion-block-ac8bea1e14e5405cb43438f0e1a47464\">某凌 EKP 由深圳市某凌软件股份有限公司开发，是一款面向中小企业的移动化智能办公产品。</div><div class=\"notion-text notion-block-ea84504fdc9e4227b85ac08235f9bbbe\">该系统存在远程命令执行漏洞，攻击者能够借助 <code class=\"notion-inline-code\">sysUiComponent</code> 接口的 <code class=\"notion-inline-code\">replaceExtend</code> 方法，把 <code class=\"notion-inline-code\">dataxml.jsp</code>后台命令执行漏洞转化为前台命令执行漏洞。</div><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-983940e3b32143dcac5345c8db5d17c3\" data-id=\"983940e3b32143dcac5345c8db5d17c3\"><span><div id=\"983940e3b32143dcac5345c8db5d17c3\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#983940e3b32143dcac5345c8db5d17c3\" title=\"影响版本\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>影响版本</b></span></span></h2><h2 class=\"notion-h notion-h1 notion-h-indent-0 notion-block-88b0545f0a36459590db982f05167399\" data-id=\"88b0545f0a36459590db982f05167399\"><span><div id=\"88b0545f0a36459590db982f05167399\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#88b0545f0a36459590db982f05167399\" title=\"漏洞分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞分析</b></span></span></h2><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-cacfbe6324c242beab39e52dc0d8a965\" data-id=\"cacfbe6324c242beab39e52dc0d8a965\"><span><div id=\"cacfbe6324c242beab39e52dc0d8a965\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#cacfbe6324c242beab39e52dc0d8a965\" title=\"前置漏洞\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>前置漏洞</b></span></span></h3><div class=\"notion-text notion-block-308f49e0425042389c748839ba7e1eff\">该漏洞属于后台 dataxml.jsp 远程命令执行的前台绕过版本，接下来先介绍一下此后台漏洞的原理。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-f99e8e5d17bb4c27937710bac9589503\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:705px;max-width:100%;flex-direction:column\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F7a84732e-6350-41c6-8b8b-653192eac326%2FUntitled.png?table=block&amp;id=f99e8e5d-17bb-4c27-9377-10bac9589503&amp;t=f99e8e5d-17bb-4c27-9377-10bac9589503&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-84824ff4a31c45ac8b1fb0f39f1e86d8\">在此处执行了 <code class=\"notion-inline-code\">treeBean</code> 的 <code class=\"notion-inline-code\">getDataList</code> 方法，并传入了请求的参数。而 <code class=\"notion-inline-code\">SysFormulaSimulateByJS</code> 类继承了 <code class=\"notion-inline-code\">IXMLDataBean</code>，其 getDataList 方法如下：</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-5d78e1f8f13b4193831853fe5695ea23\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Febca82f9-923b-42d7-b727-8a73fdb76e71%2FUntitled.png?table=block&amp;id=5d78e1f8-f13b-4193-8318-53fe5695ea23&amp;t=5d78e1f8-f13b-4193-8318-53fe5695ea23&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-d476f17c7e334b7f8b329314a10bfb2b\">通过 <code class=\"notion-inline-code\">FormulaParser#parseValueScript()</code> 执行了传入的 script 脚本，尽管禁用了 unicode 以及一些黑名单，但未禁用 <code class=\"notion-inline-code\">Runtime.exec</code> 和 <code class=\"notion-inline-code\">ProcessBuilder</code>，所以仍然能够执行命令。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-3a4dedf254104a8e87eb5afebe9c10eb\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Ffccac46d-8ba1-4c0d-b081-0a8b4e342b6b%2FUntitled.png?table=block&amp;id=3a4dedf2-5410-4a8e-87eb-5afebe9c10eb&amp;t=3a4dedf2-5410-4a8e-87eb-5afebe9c10eb&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-b32f70d602fe43b7a6ecd0199bd740eb\">这种利用 bsh 的打法还有许多接口可用，在此不逐一举例，更多详情见：<a target=\"_blank\" rel=\"noopener noreferrer\" class=\"notion-link\" href=\"https://github.com/ax1sX/SecurityList/blob/main/Java_OA/LandrayEkpAudit.md\">LandrayEkpAudit</a></div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-e4ba653a308a4d7db9fb27c81daf3feb\" data-id=\"e4ba653a308a4d7db9fb27c81daf3feb\"><span><div id=\"e4ba653a308a4d7db9fb27c81daf3feb\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#e4ba653a308a4d7db9fb27c81daf3feb\" title=\"漏洞绕过\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>漏洞绕过</b></span></span></h3><div class=\"notion-text notion-block-2219d6d9537a482cb09204f058175f74\">这个洞后来加了权限校验(WEB-INF/KmssConfig/sys/authentication/spring.xml)，匿名用户仅允许访问以下接口：</div><div class=\"notion-text notion-block-6f67a7405a304a6da7e6f0f38da94db3\">还有一种打法是通过custom.jsp去SSRF打dataxml.jsp。不过这里也已经无法利用了。</div><div class=\"notion-text notion-block-b002bb3f7f25456286e167272c30bf94\">在该系统V16版本中，引入了<code class=\"notion-inline-code\">SysUiComponent</code>，并且在<code class=\"notion-inline-code\">design.xml</code>(WEB-INF/KmssConfig/sys/ui/design.xml)和<code class=\"notion-inline-code\">spring.xml</code>中忘记添加鉴权，导致可调用<code class=\"notion-inline-code\">SysUiComponentAction#getThemeInfo</code>进行文件上传。</div><div class=\"notion-text notion-block-c3fd6159521c43ca903de6b3d485f968\">这次漏洞的绕过方式是通过<code class=\"notion-inline-code\">SysUiComponentAction#replaceExtend()</code>将<code class=\"notion-inline-code\">dataxml.jsp</code>所在目录的文件复制到可访问的目录。</div><blockquote class=\"notion-quote notion-block-c9aca6245dc0483e9659e51e1913515b\"><div>借助这个漏洞，我们能够将其移动至无需鉴权的位置，也就是配置中的静态资源或者匿名路径所在之处。</div></blockquote><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-9c04f67989aa40bca9b1130c8d5513a9\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F43bbd522-a90f-4d6e-9f18-a947bec8d4c9%2FUntitled.png?table=block&amp;id=9c04f679-89aa-40bc-a9b1-130c8d5513a9&amp;t=9c04f679-89aa-40bc-a9b1-130c8d5513a9&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-8c876956f5774bef97b7a4c2c4e66156\">继续跟进，调用的是<code class=\"notion-inline-code\">SysUiComponentService#replaceExtend()</code></div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-149dcc9f3d9b4d7e9b9866e6f2279090\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F307c316d-a7d5-4ca6-bc7c-d9bd5a2c1482%2FUntitled.png?table=block&amp;id=149dcc9f-3d9b-4d7e-9b98-66e6f2279090&amp;t=149dcc9f-3d9b-4d7e-9b98-66e6f2279090&amp;width=909&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-d481b17e78874d65b12021b1e9acaf30\">这里获取两个参数的值，删除extendId目录，然后将folderName目录的文件复制过来。</div><figure class=\"notion-asset-wrapper notion-asset-wrapper-image notion-block-0a930a1c6ef04ca099f0234c1ebf225d\"><div style=\"position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%\"><img style=\"object-fit:cover\" src=\"https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fc418a934-6350-47f7-8bb7-6b974c059a59%2FUntitled.png?table=block&amp;id=0a930a1c-6ef0-4ca0-99f0-234c1ebf225d&amp;t=0a930a1c-6ef0-4ca0-99f0-234c1ebf225d&amp;width=705&amp;cache=v2\" alt=\"notion image\" loading=\"lazy\" decoding=\"async\"/></div></figure><div class=\"notion-text notion-block-2e81681d37974d19891fea9160d1f732\">继续跟进copyDirectory得到：</div><div class=\"notion-text notion-block-99c54d952fdc4764912d77cbfc82adde\">继续跟进</div><div class=\"notion-text notion-block-8daccba4ac4548e8b40133b7cc8249c7\">最后通过<code class=\"notion-inline-code\">Files.copy</code>将一个目录及其内容递归地复制到另一个目录。</div><h3 class=\"notion-h notion-h2 notion-h-indent-1 notion-block-d8721d60cd58462b8f5e7cb9ca70c49e\" data-id=\"d8721d60cd58462b8f5e7cb9ca70c49e\"><span><div id=\"d8721d60cd58462b8f5e7cb9ca70c49e\" class=\"notion-header-anchor\"></div><a class=\"notion-hash-link\" href=\"#d8721d60cd58462b8f5e7cb9ca70c49e\" title=\"路由分析\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a><span class=\"notion-h-title\"><b>路由分析</b></span></span></h3><div class=\"notion-text notion-block-75aae2eb72994828834a4f5e7f6c667d\">通过分析配置文件 <code class=\"notion-inline-code\">/WEB-INF/KmssConfig/sys/ui/spring-mvc.xml</code>，我们可以得出以下结论：</div><div class=\"notion-text notion-block-907f30f3923042fab72756e0f12ec7b9\">访问方式</div><ul class=\"notion-list notion-list-disc notion-block-e855e00d9f46485dae9a37e327149893\"><li><b>URL</b>: <code class=\"notion-inline-code\">/sys/ui/sys_ui_component/sysUiComponent.do</code></li></ul><ul class=\"notion-list notion-list-disc notion-block-0d1612e2268b44e59efbadb8c075bd05\"><li><b>类</b>: <code class=\"notion-inline-code\">com.landray.kmss.sys.ui.actions.SysUiComponentAction</code></li></ul><div class=\"notion-text notion-block-7e89aba8234d492891902d45175d8a84\">调用特定方法</div><div class=\"notion-text notion-block-0d12b302a62c486683d5ae821c91103e\">要调用 <code class=\"notion-inline-code\">SysUiComponentAction</code> 类中的 <code class=\"notion-inline-code\">replaceExtend()</code> 方法，需要在URL中添加 <code class=\"notion-inline-code\">method</code> 参数</div><div class=\"notion-text notion-block-0f4ede0bb7b24d409e2dd98ec1883e7b\">接下来如何构造PoC就很清晰了，只需要将<code class=\"notion-inline-code\">dataxml.jsp</code>所在的目录<code class=\"notion-inline-code\">/sys/common</code>通过目录穿越复制到匿名用户可访问的Web目录即可。</div><div class=\"notion-text notion-block-e1bf209a6c4045559de443d761391a1c\">执行命令</div><div class=\"notion-blank notion-block-df8746cc538b48aea0c687f8efde7226\"> </div></main></div>",
            "url": "https://www.le1a.me//article/ekp",
            "title": "蓝凌EKP 远程代码执行漏洞分析",
            "date_modified": "2024-06-25T16:00:00.000Z"
        }
    ]
}