<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id/>
    <title>Le1a的菜园坝 </title>
    <updated>2025-11-21T05:04:44.892Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <author>
        <name>Le1a</name>
        <email>le1a.github.io@gmail.com</email>
        <uri>https://le1a.github.io</uri>
    </author>
    <link rel="alternate" href="https://le1a.github.io/"/>
    <subtitle>一个NotionNext搭建的博客</subtitle>
    <icon>https://le1a.github.io/favicon.png</icon>
    <rights>All rights reserved 2025, Le1a</rights>
    <entry>
        <title type="html"><![CDATA[Atlassian Confluence 模板注入漏洞（CVE-2023-22527）]]></title>
        <id>https://le1a.github.io/article/confluence-velocity</id>
        <link href="https://le1a.github.io/article/confluence-velocity"/>
        <updated>2024-01-21T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-1317c0311dd6805bb1a8e107ec9094f6"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><div class="notion-text notion-block-1317c0311dd680cb8991d09aac605f8a">文章首发自<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://forum.butian.net/share/2741">奇安信攻防社区</a></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1317c0311dd68036a4f5c5942825e3b5" data-id="1317c0311dd68036a4f5c5942825e3b5"><span><div id="1317c0311dd68036a4f5c5942825e3b5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1317c0311dd68036a4f5c5942825e3b5" title="漏洞分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><b>漏洞分析</b></span></span></h2><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd68040b925db0899a1dbc1" data-id="1317c0311dd68040b925db0899a1dbc1"><span><div id="1317c0311dd68040b925db0899a1dbc1" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1317c0311dd68040b925db0899a1dbc1" title="漏洞原理"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><b>漏洞原理</b></span></span></h3><div class="notion-text notion-block-1317c0311dd680baadd3ea89a1ba3604">在Confluence中，.vm文件是使用Velocity模板语言创建的模板文件。Velocity是一个基于Java的模板引擎，它允许你使用简单的标记语言来引用Java对象和方法，从而动态生成HTML、XML或任何文本格式的内容。</div><div class="notion-text notion-block-1317c0311dd6806eb9c0ee817c023dc6">处理.vm文件的主要类是ConfluenceVelocityServlet。这个Servlet负责接收和处理来自浏览器的请求，加载和解析.vm模板，执行其中的Velocity代码，然后将生成的HTML发送回浏览器。</div><div class="notion-text notion-block-1317c0311dd6804b9171f54ebb54c0e5">这次的漏洞点位于：/template/aui/text-inline.vm文件，可以直接通过/template/aui/text-inline.vm访问</div><div class="notion-text notion-block-1317c0311dd68078b88bcb822eea9003"><code class="notion-inline-code">$stack.findValue(&quot;getText(&#x27;$parameters.label&#x27;)&quot;)</code>意味着从请求中获取的label参数的值传入了<code class="notion-inline-code">$stack.findValue</code>，由此可以判断这里存在模版注入！</div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd680a09a5bfc7bfd204618" data-id="1317c0311dd680a09a5bfc7bfd204618"><span><div id="1317c0311dd680a09a5bfc7bfd204618" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1317c0311dd680a09a5bfc7bfd204618" title="调用分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><b>调用分析</b></span></span></h3><div class="notion-text notion-block-1317c0311dd68001b4cfc1dc454c9d2e">.vm文件由<code class="notion-inline-code">ConfluenceVelocityServlet</code>处理</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680ea97bcc2c2790a2d30"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F99db354f-26d5-4d3b-b6c6-81dc2342be1a%2Fe22f77c1549f4aa6b310ec5d33c8de0d.png?table=block&amp;id=1317c031-1dd6-80ea-97bc-c2c2790a2d30&amp;t=1317c031-1dd6-80ea-97bc-c2c2790a2d30&amp;width=707.828125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd680dd9a22c3af55075a54">继续跟进</div><div class="notion-text notion-block-1317c0311dd680968981fc03472fdf98">这里跟进<code class="notion-inline-code">handleRequest()</code>，可以发现从URI中获取vm文件路径，传入<code class="notion-inline-code">getTemplate()</code>来返回模版对象</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68024b385cc3b822698f9"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F993515ab-4052-49a5-aed3-797a9633dd17%2Fimage.png?table=block&amp;id=1317c031-1dd6-8024-b385-cc3b822698f9&amp;t=1317c031-1dd6-8024-b385-cc3b822698f9&amp;width=707.96875&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd6800bb885f23d6640a32b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F15b87c5a-4b6a-436c-8310-f67a666781fc%2F97a75a2c0bfa0e50a7cd60d0233d754e.png?table=block&amp;id=1317c031-1dd6-800b-b885-f23d6640a32b&amp;t=1317c031-1dd6-800b-b885-f23d6640a32b&amp;width=707.84375&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd6801b9e66c5989b10b8ef">然后传入<code class="notion-inline-code">mergeTemplate()</code>函数处理</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd6801eb7dbf3d4fa01d0b7"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fb30aeefa-7b83-4f46-b71a-6cdc4fc7e59d%2Fimage.png?table=block&amp;id=1317c031-1dd6-801e-b7db-f3d4fa01d0b7&amp;t=1317c031-1dd6-801e-b7db-f3d4fa01d0b7&amp;width=707.984375&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd680d287b3e7eb23987e6d">这里创建新的PageContext，获取其输出流，准备进行模板合并和输出操作。</div><div class="notion-text notion-block-1317c0311dd68024a25bd65239f0fe00">继续跟进<code class="notion-inline-code">template.merge()</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680e19f43e1fbb1a9fead"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fc4c74208-bc44-4e91-aa24-29f6e26bb8d5%2Fimage.png?table=block&amp;id=1317c031-1dd6-80e1-9f43-e1fbb1a9fead&amp;t=1317c031-1dd6-80e1-9f43-e1fbb1a9fead&amp;width=707.828125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd6807e986ddaa9487ab078">跟进到merge的重载函数</div><div class="notion-text notion-block-1317c0311dd680f08ebeecd435b86cb5">由于传入的macroLibraries为空，所以直接执行try逻辑</div><ol start="1" class="notion-list notion-list-numbered notion-block-1317c0311dd68081ab39ea77aaf744b9"><li>调用 <code class="notion-inline-code">ica.pushCurrentTemplateName(this.name);</code> 将当前模板的名称压入到 <code class="notion-inline-code">ica</code> 的模板名堆栈中。这是为了在嵌套模板的情况下能够追踪到当前正在处理的模板名称。</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-1317c0311dd680f5bf8dc3bf7c370d2e"><li>调用 <code class="notion-inline-code">ica.setCurrentResource(this);</code> 将当前模板对象设置为 <code class="notion-inline-code">ica</code> 的当前资源。这是为了让 <code class="notion-inline-code">ica</code> 知道当前正在处理的模板资源。</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-1317c0311dd680d3b8c9c771ac2d6331"><li>最后，通过调用 <code class="notion-inline-code">((SimpleNode)this.data).render(ica, writer);</code> 进行模板渲染</li></ol><div class="notion-text notion-block-1317c0311dd680fbb80ac1266ce4fa51">省略中间的部分渲染过程，跟进到<code class="notion-inline-code">ASTReference#execute()</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680cb9c24f95f4fa2e7b9"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F5e740428-8285-4aeb-9958-6f02563498e1%2Fimage.png?table=block&amp;id=1317c031-1dd6-80cb-9c24-f95f4fa2e7b9&amp;t=1317c031-1dd6-80cb-9c24-f95f4fa2e7b9&amp;width=707.953125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd680388acbf473e685d746">这里从上下文中获取OgnlValueStack，继续跟进</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68019865bfa6d8ead0ea2"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F44225b74-de09-4018-b27f-277590603a3a%2F690287b645ae33dfc462717e50a1d0cf.png?table=block&amp;id=1317c031-1dd6-8019-865b-fa6d8ead0ea2&amp;t=1317c031-1dd6-8019-865b-fa6d8ead0ea2&amp;width=707.953125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68059b12df7d53b88ff34"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6fe3bec0-d754-4d8a-9538-60dc91f11021%2F544288fb70d17ceafa3f06389f68cd6c.png?table=block&amp;id=1317c031-1dd6-8059-b12d-f7d53b88ff34&amp;t=1317c031-1dd6-8059-b12d-f7d53b88ff34&amp;width=707.90625&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd68070b2ecc60ce5c07432">这里从请求中获取到参数，然后通过<code class="notion-inline-code">Object obj = method.invoke(o, params);</code>执行，继续跟进</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680179a32efa5220908ea"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F9c358602-f3bf-464f-bdeb-89c067d77175%2Fed5c01b18467688afa915ea3c790f2bd.png?table=block&amp;id=1317c031-1dd6-8017-9a32-efa5220908ea&amp;t=1317c031-1dd6-8017-9a32-efa5220908ea&amp;width=707.921875&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd68057ba86e8e210f39003">经过几层invoke调用后，来到了最终vm文件模版的位置——<code class="notion-inline-code">OgnlValueStack.findValue()</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680fab583f4d3532af4c3"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fbf23f16f-d827-4550-b52a-4780c209c59c%2F6c71d0aace93017b4bacb4d4ecf292b1.png?table=block&amp;id=1317c031-1dd6-80fa-b583-f4d3532af4c3&amp;t=1317c031-1dd6-80fa-b583-f4d3532af4c3&amp;width=707.984375&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1317c0311dd68075838bc71ab561654a">随后，传给label参数的OGNL表达式语句被执行</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680118768d61d5e7ee02c"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:650px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F6bf97707-7247-4990-b53c-ea2448e33da0%2F4d1a9301a88dd689252d23be73a0cec0.png?table=block&amp;id=1317c031-1dd6-8011-8768-d61d5e7ee02c&amp;t=1317c031-1dd6-8011-8768-d61d5e7ee02c&amp;width=650&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-1317c0311dd6802cbec3e2f328819293" data-id="1317c0311dd6802cbec3e2f328819293"><span><div id="1317c0311dd6802cbec3e2f328819293" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1317c0311dd6802cbec3e2f328819293" title="绕过沙箱RCE"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><b>绕过沙箱RCE</b></span></span></h3><div class="notion-text notion-block-1317c0311dd68020ba60e18d17f7a34a">由这篇文章可得知：<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context">https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context</a></div><div class="notion-text notion-block-1317c0311dd680159521d4a28672528f">对于Velocity模版引擎，可以使用如下方法：</div><ul class="notion-list notion-list-disc notion-block-1317c0311dd680c9a718df7f30fd355f"><li><code class="notion-inline-code">.KEY_velocity.struts2.context</code> -&gt; (<code class="notion-inline-code">StrutsVelocityContext</code>)</li><ul class="notion-list notion-list-disc notion-block-1317c0311dd680c9a718df7f30fd355f"><li><code class="notion-inline-code">ognl</code> (<code class="notion-inline-code">org.apache.struts2.views.jsp.ui.OgnlTool</code>)</li><li><code class="notion-inline-code">struts</code> (<code class="notion-inline-code">org.apache.struts2.views.velocity.result.VelocityStrutsUtils</code>)</li></ul></ul><div class="notion-text notion-block-1317c0311dd68070b21de82586e09219">org.apache.struts2.views.jsp.ui.OgnlTool 类在没有 OgnlContext 的情况下调用了 Ognl.getValue()。</div><ol start="1" class="notion-list notion-list-numbered notion-block-2b27c0311dd6800bb172fb19331bf293"><li><b>正常的 Struts OGNL 执行：</b></li><ol class="notion-list notion-list-numbered notion-block-2b27c0311dd6800bb172fb19331bf293"><div class="notion-text notion-block-2b27c0311dd68037a628f410fbc42f53">当 Struts2 处理 HTTP 参数或标签时，它会创建一个 OgnlContext。为了安全，Struts 会向这个 Context 中注入一个 <b>SecurityMemberAccess</b> 对象。这个对象充当“看门人”，禁止访问静态方法、禁止访问 java.lang.Runtime、禁止访问 _memberAccess 等。</div></ol></ol><ol start="2" class="notion-list notion-list-numbered notion-block-2b27c0311dd680218e4dd162089ea832"><li><b>Velocity 的 OgnlTool 漏洞：</b></li><ol class="notion-list notion-list-numbered notion-block-2b27c0311dd680218e4dd162089ea832"><div class="notion-text notion-block-2b27c0311dd6800c8c8ff332ae57102f">在 Velocity 模版渲染时，如果上下文中存在 $ognl (即 OgnlTool 实例)，攻击者可以调用 $ognl.findValue(&quot;payload&quot;)。</div><ul class="notion-list notion-list-disc notion-block-2b27c0311dd6803abb50e43bf305010a"><li>OgnlTool.findValue 的内部实现最终会调用原生 OGNL 库的 Ognl.getValue(expression, context, root)。</li></ul><ul class="notion-list notion-list-disc notion-block-2b27c0311dd680bb9528c7eea7c85ff3"><li><b>关键点：</b> 如果 OgnlTool 在调用 Ognl.getValue 时，传入的是一个新的 Context，或者是没有配置 SecurityMemberAccess 的 Context，那么 OGNL 就会使用默认的、宽松的 DefaultMemberAccess。</li></ul><ul class="notion-list notion-list-disc notion-block-2b27c0311dd680738c1bd46d9998c19f"><li><b>结果：</b> DefaultMemberAccess 允许访问任何 public 方法，包括 Runtime.exec()。因此，Struts 的黑名单策略完全失效。</li></ul></ol></ol><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68098a508fbafe0734710"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F754b5e1b-0658-44aa-b487-8f98f30cfbfd%2F5473a8f4ae2a8e00f10d22368c6b5699.png?table=block&amp;id=1317c031-1dd6-8098-a508-fbafe0734710&amp;t=1317c031-1dd6-8098-a508-fbafe0734710&amp;width=2538&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1317c0311dd68009a095fdb5b1b6e980" data-id="1317c0311dd68009a095fdb5b1b6e980"><span><div id="1317c0311dd68009a095fdb5b1b6e980" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1317c0311dd68009a095fdb5b1b6e980" title="漏洞复现"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><b>漏洞复现</b></span></span></h2><ol start="1" class="notion-list notion-list-numbered notion-block-1317c0311dd68099b128d561d5c03e82"><li>网站首页如下图：</li></ol><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd68015856eea9e4e0b9c4c"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F4df4b43f-dbfb-419f-9b3a-aa9bcc81d496%2F073dda6525265eb10056a37ca253689a.png?table=block&amp;id=1317c031-1dd6-8015-856e-ea9e4e0b9c4c&amp;t=1317c031-1dd6-8015-856e-ea9e4e0b9c4c&amp;width=3004&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><ol start="1" class="notion-list notion-list-numbered notion-block-1317c0311dd680d4b24fd1bfb68fefd4"><li>使用如下POC进行漏洞复现</li></ol><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1317c0311dd680fb8577f6c4cd8b2472"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F71a4d1a0-832b-4558-a3ab-8f3e5d1debd6%2Fimage.png?table=block&amp;id=1317c031-1dd6-80fb-8577-f6c4cd8b2472&amp;t=1317c031-1dd6-80fb-8577-f6c4cd8b2472&amp;width=2822&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[用友U8Cloud 反射调用 → 文件上传漏洞]]></title>
        <id>https://le1a.github.io/article/23f7c031-1dd6-80cd-a698-cb9bbd1692a0</id>
        <link href="https://le1a.github.io/article/23f7c031-1dd6-80cd-a698-cb9bbd1692a0"/>
        <updated>2025-07-28T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-23f7c0311dd680cda698cb9bbd1692a0"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-23f7c0311dd6803a9927fd6fa7a2487b" data-id="23f7c0311dd6803a9927fd6fa7a2487b"><span><div id="23f7c0311dd6803a9927fd6fa7a2487b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#23f7c0311dd6803a9927fd6fa7a2487b" title="漏洞分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞分析</span></span></h2><div class="notion-text notion-block-23f7c0311dd68034bbfef81a7e5fc977">首先根据漏洞描述得知：</div><blockquote class="notion-quote notion-block-23f7c0311dd680bb8690f04c3ae8ad5c"><div>该漏洞存在于人力资源模块（hrpub）的文件上传函数中。由于该函数对上传路径和文件类型缺乏有效校验，导致存在任意文件上传漏洞。</div><div class="notion-text notion-block-23f7c0311dd680e6917af69f4237cf75">攻击者可绕过入口 ServiceDispatcherServlet 的 token 验证，通过构造请求反射调用 nc.itf.hr.tools.IFileTrans.uploadFile 方法，执行文件上传操作，实现任意文件写入，从而获取系统控制权。</div></blockquote><div class="notion-text notion-block-23f7c0311dd6800a8d01f7398e1b7a4f"><code class="notion-inline-code">/ServiceDispatcherServlet</code>路径对应的<code class="notion-inline-code">nc.bs.framework.comn.serv.CommonServletDispatcher</code>类。</div><div class="notion-text notion-block-23f7c0311dd680d098a9e4c4f319dd3f"><code class="notion-inline-code">CommonServletDispatcher</code>的<code class="notion-inline-code">doGet</code>会调用<code class="notion-inline-code">serviceHandler.execCall()</code>。<code class="notion-inline-code">serviceHandler</code>从<code class="notion-inline-code">this.getInitParameter(&quot;service&quot;)</code>获取，在web.xml中配置为<code class="notion-inline-code">nc.bs.framework.comn.serv.ServiceDispatcher</code></div><div class="notion-text notion-block-23f7c0311dd680a28a1dee6eae2af721">下面是复现过程中的插曲….搞忘了这个是在web.xml中配置的了/(ㄒoㄒ)/~~</div><blockquote class="notion-quote notion-block-23f7c0311dd6801f9324c6e5e8b7eafc"><div>其中serviceHandler传入service来获取目标全类名。本来以为service可控，能传入2个选择：</div><ul class="notion-list notion-list-disc notion-block-23f7c0311dd68007b418e2323b27ed26"><li>fw.jar的nc/bs/framework/comn/serv/ServiceDispatcher.class</li></ul><ul class="notion-list notion-list-disc notion-block-23f7c0311dd680388d78c7ce19714ce8"><li><s>ncdepend.jar的nc/bs/framework/comn/serv/ServiceDispatcher.class</s></li></ul><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd680ba911efdcc544dcc04"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Ae7b43d05-8e44-4b28-8efa-6f4fb1811796%3Aassetsimage-20250729122919-xzbxrl1.png?table=block&amp;id=23f7c031-1dd6-80ba-911e-fdcc544dcc04&amp;t=23f7c031-1dd6-80ba-911e-fdcc544dcc04" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-23f7c0311dd6809c91ddeb04e992c1ba">但实际上这里的service只是一个字符串，得到的结果是固定的。由于<code class="notion-inline-code">CommonServletDispatcher</code>是<code class="notion-inline-code">fw.jar</code>中的，所以只能调用到<code class="notion-inline-code">fw.jar</code>的<code class="notion-inline-code">nc/bs/framework/comn/serv/ServiceDispatcher.class</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd680bb8f7ce09d029dbb47"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A152691aa-904e-4392-ad7a-6195a88e0a19%3Aassetsimage-20250729145437-eu180on.png?table=block&amp;id=23f7c031-1dd6-80bb-8f7c-e09d029dbb47&amp;t=23f7c031-1dd6-80bb-8f7c-e09d029dbb47" alt="notion image" loading="lazy" decoding="async"/></div></figure></blockquote><div class="notion-text notion-block-23f7c0311dd68074ab52e36586cb7255">回到正题，继续跟进到<code class="notion-inline-code">ServiceDispatcher#execCall()</code></div><div class="notion-text notion-block-23f7c0311dd680c484d2c1c68fdd56be">从请求中读取输入流，并通过反序列化操作将数据转换为 InvocationInfo 对象，该对象封装了目标服务的调用元信息（包括模块名、服务名、方法名、参数类型及参数值），随后通过反射机制动态调用对应的业务方法。</div><div class="notion-text notion-block-23f7c0311dd680aca9ade4148cd843bf">但这里需要先经过token鉴权。这里跟进<code class="notion-inline-code">vertifyToken()</code>继续分析：</div><div class="notion-text notion-block-23f7c0311dd68059bc1adced40b174ef">这里如果是可信服务 or 可信客户端IP就无需鉴权，可惜下面要用到的<code class="notion-inline-code">nc.itf.hr.tools.IFileTrans</code>不属于可信服务。可信IP虽然通过XFF获取，可以伪造，但是默认的可信IP列表为空，也就无从下手了。只能继续分析<code class="notion-inline-code">vertifyTokenIllegal()</code></div><div class="notion-text notion-block-23f7c0311dd680378b33e6464fcd4c1e">这里传入userCode的值，通过genToken生成token，与传入的token对比，相同即可绕过。继续分析<code class="notion-inline-code">genToken()</code></div><div class="notion-blank notion-block-23f7c0311dd6806bb4e8e83f26d5dc4c"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd6809dad0be1dec1090b0d"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Ac4b71898-e7ca-445a-91d6-71959e3c181b%3Aassetsimage-20250729151926-d6j0akl.png?table=block&amp;id=23f7c031-1dd6-809d-ad0b-e1dec1090b0d&amp;t=23f7c031-1dd6-809d-ad0b-e1dec1090b0d" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-23f7c0311dd6807ea636e8d9e499ca31"> </div><div class="notion-text notion-block-23f7c0311dd680a8b623e47807f70e6f">非常明显，这里的token种子是硬编码，所以直接把代码迁移出来即可。</div><div class="notion-text notion-block-23f7c0311dd68018947ad28d205f2baf">我们根据历史漏洞：https://github.com/rix4uni/nucleihub-templates/blob/3cca879652a20bc80af95e97e41ae158862be4f4/nucleihub-templates/yongyou-u8c-esnserver-fileupload.yaml</div><div class="notion-text notion-block-23f7c0311dd6802b988cd60b86d43ce6">得知<code class="notion-inline-code">nc.itf.hr.tools.IFileTrans#uploadFile()</code>可以上传文件，接下来看看如何构造<code class="notion-inline-code">InvocationInfo</code>对象</div><div class="notion-text notion-block-23f7c0311dd680578d89ff9d0df67d82">跟进<code class="notion-inline-code">this.invokeBeanMethod(invInfo.getModule(), invInfo.getServiceName(), invInfo.getMethodName(), invInfo.getParametertypes(), invInfo.getParameters());</code></div><div class="notion-blank notion-block-23f7c0311dd68075a221cbd3dd819554"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd680e3b976efdc181ca794"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Ac6493119-3390-4a80-8424-8190b93b475a%3Aassetsimage-20250729152606-vr84a1l.png?table=block&amp;id=23f7c031-1dd6-80e3-b976-efdc181ca794&amp;t=23f7c031-1dd6-80e3-b976-efdc181ca794" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-23f7c0311dd680b1a148cc9f39162a7f"> </div><div class="notion-text notion-block-23f7c0311dd6807ea053e51fd246a793">这里需要moudle为空，才能反射调用方法。那么构造如下PoC即可：</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-23f7c0311dd68076a473ec8d5564dc7f" data-id="23f7c0311dd68076a473ec8d5564dc7f"><span><div id="23f7c0311dd68076a473ec8d5564dc7f" class="notion-header-anchor"></div><a class="notion-hash-link" href="#23f7c0311dd68076a473ec8d5564dc7f" title="漏洞复现"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞复现</span></span></h2><div class="notion-blank notion-block-23f7c0311dd680379abec340eeeeb4c1"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd680859b46d7577ee3674b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A3258340e-6769-445e-9c1c-c426b0917f9c%3Aassetsimage-20250729152219-57rhppz.png?table=block&amp;id=23f7c031-1dd6-8085-9b46-d7577ee3674b&amp;t=23f7c031-1dd6-8085-9b46-d7577ee3674b" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-23f7c0311dd68076956ac9e4d30fb8f4"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd68020b8dbe5843d10fc70"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Ac2c2c077-3728-49ac-b3d0-cdceae77de8f%3Aassetsimage-20250729152307-twubx8r.png?table=block&amp;id=23f7c031-1dd6-8020-b8db-e5843d10fc70&amp;t=23f7c031-1dd6-8020-b8db-e5843d10fc70" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-23f7c0311dd680db8747e216add21920"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-23f7c0311dd6803e944ff41c063fa2c0"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A9c357979-20af-45c1-9dbd-8e1aa606413a%3Aassetsimage-20250729152314-hu2bedr.png?table=block&amp;id=23f7c031-1dd6-803e-944f-f41c063fa2c0&amp;t=23f7c031-1dd6-803e-944f-f41c063fa2c0" alt="notion image" loading="lazy" decoding="async"/></div></figure><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-23f7c0311dd68071a632d277af0ed92d" data-id="23f7c0311dd68071a632d277af0ed92d"><span><div id="23f7c0311dd68071a632d277af0ed92d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#23f7c0311dd68071a632d277af0ed92d" title="漏洞修复"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞修复</span></span></h2><div class="notion-text notion-block-23f7c0311dd680169f15e3c83988ffa1">在文件上传这里，把webapps/u8c_web拉到黑名单了，无论是../还是大小写都没能绕过...../(ㄒoㄒ)/~~</div><div class="notion-text notion-block-23f7c0311dd6801982aef6487c91fe65">一些其他思路：</div><ul class="notion-list notion-list-disc notion-block-23f7c0311dd6807fac7ff9c4901da6d0"><li>写bat覆盖start.bat或者stop.bat，等后续有好心人双击</li></ul><ul class="notion-list notion-list-disc notion-block-23f7c0311dd680d5be13cdb72b58de48"><li>写class覆盖，等重启</li></ul><ul class="notion-list notion-list-disc notion-block-23f7c0311dd68072a9ddef89ed434753"><li>直接写一个同名war包，覆盖原有web项目(测试失败)</li></ul><ul class="notion-list notion-list-disc notion-block-23f7c0311dd680a98130c1db7f923c0d"><li>学习<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/Y4tacker/JavaSec/blob/main/8.%E5%85%B3%E4%BA%8ETomcat%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%86%E4%BA%AB/Tomcat%E4%B8%8A%E4%BC%A0.war%E8%A7%A6%E5%8F%91JNDI/index.md">Y4的骚姿势</a>，上传war包，META-INF/context.xml放以下内容，触发JNDI注入(暂时失败)</li><ul class="notion-list notion-list-disc notion-block-23f7c0311dd680a98130c1db7f923c0d"></ul></ul><div class="notion-text notion-block-23f7c0311dd68094801cf85197566101">‍</div><div class="notion-text notion-block-23f7c0311dd68095b9affd135163c397">‍</div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[禅道二次SQL注入到RCE漏洞分析]]></title>
        <id>https://le1a.github.io/article/zentao-sql-to-rce</id>
        <link href="https://le1a.github.io/article/zentao-sql-to-rce"/>
        <updated>2024-09-02T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-be75730e69f349a281b9ca6da27104c7"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-3b42ce3773ad40a19baa8fd688a31aad" data-id="3b42ce3773ad40a19baa8fd688a31aad"><span><div id="3b42ce3773ad40a19baa8fd688a31aad" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3b42ce3773ad40a19baa8fd688a31aad" title="漏洞简介"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞简介</span></span></h2><div class="notion-text notion-block-41cf09416cbd433580740091fa081dcb">禅道是一款由青岛易软天创网络科技有限公司开发的国产开源项目管理软件，旨在帮助团队高效管理项目、任务分配和团队协作。</div><div class="notion-text notion-block-a332573086e04a739acd59e9776e593c">在preference函数中会把键值对插入数据库配置，然后在router::setControlFile中,会从数据库中读取配置信息，如果修改edition和vision参数，将恶意SQL语句注入到数据库配置中。当访问特定URL触发router::setControlFile时就会触发SQL，造成二次注入。</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-a91c192e70b9472e864256089a9f919c" data-id="a91c192e70b9472e864256089a9f919c"><span><div id="a91c192e70b9472e864256089a9f919c" class="notion-header-anchor"></div><a class="notion-hash-link" href="#a91c192e70b9472e864256089a9f919c" title="影响版本"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">影响版本</span></span></h2><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-f16786033d7e412bb1a13b78b6c125d5" data-id="f16786033d7e412bb1a13b78b6c125d5"><span><div id="f16786033d7e412bb1a13b78b6c125d5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f16786033d7e412bb1a13b78b6c125d5" title="漏洞分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞分析</span></span></h2><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-7ae6b170d6254485a30606453adb8ee8" data-id="7ae6b170d6254485a30606453adb8ee8"><span><div id="7ae6b170d6254485a30606453adb8ee8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7ae6b170d6254485a30606453adb8ee8" title="注入点"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">注入点</span></span></h3><div class="notion-text notion-block-bc51526058684e37bfd99700da14fd65">在<code class="notion-inline-code">zentao/framework/router.class.php#setControlFile()</code>中，当满足以下两个条件时，存在拼接SQL注入：<code class="notion-inline-code">$this-&gt;config-&gt;vision</code></div><ul class="notion-list notion-list-disc notion-block-9aeb2778da4c4f5189cf04df537cfe54"><li><code class="notion-inline-code">$this-&gt;config-&gt;edition</code>不为<code class="notion-inline-code">open</code></li></ul><ul class="notion-list notion-list-disc notion-block-2f6f2b1b72e5420b83de69fd56af4b14"><li><code class="notion-inline-code">moduleName</code>在<code class="notion-inline-code">WORKFLOW</code>表中存在</li></ul><div class="notion-text notion-block-12000090119b45b4b3615465d9d0d4af"><code class="notion-inline-code">version</code>的值有两个来源：</div><ol start="1" class="notion-list notion-list-numbered notion-block-a6cdd15c9263447492de22708272662c"><li>配置文件：来自<code class="notion-inline-code">config.php</code>中的设置</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-3c293f4b280d4677ab442323f4cd783b"><li>数据库：存储在<code class="notion-inline-code">zt_config</code>表中</li></ol><div class="notion-text notion-block-a6d3ba7b5c6d4146a85936151eb8e044"><b>配置文件加载过程</b></div><div class="notion-text notion-block-7cf9aac6d3a045d29a67d97347a29c9e">在访问index.php的时候会创建应用实例，并根据配置文件初始化：</div><div class="notion-text notion-block-f96eb534e7d54fe0ba2e1cff6df8cf4d">这里调用了<code class="notion-inline-code">$this-&gt;loadMainConfig();</code>来加载配置文件</div><div class="notion-text notion-block-8ba04840449b485390974f42da22c23d"><b>从数据库加载用户配置</b></div><div class="notion-text notion-block-69007d13861142f997003b5b31170e61">在创建实例后，开始运行实例，在这个时候还从数据库中加载了配置</div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-c5d0c3fce9a44c03b719cd2de58dec0e" data-id="c5d0c3fce9a44c03b719cd2de58dec0e"><span><div id="c5d0c3fce9a44c03b719cd2de58dec0e" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c5d0c3fce9a44c03b719cd2de58dec0e" title="插入SQL语句至数据库"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">插入SQL语句至数据库</span></span></h3><div class="notion-text notion-block-ae8a7d1605614e5890a23ffa40bfcf6e">在 <code class="notion-inline-code">module/my/control.php#preference()</code>中,系统直接将 POST 请求中的所有参数写入数据库配置,没有进行任何验证或过滤:</div><div class="notion-text notion-block-1e6e79d360c54b9a99a02ebe806979e7">使用如下PoC即可将SQL语句插入<code class="notion-inline-code">zt_config</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-3edfd96f754c4d19b12ec410559047c1"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F7a1724de-d595-4e54-bcee-2ad9b9de9b76%2Fimage.png?table=block&amp;id=3edfd96f-754c-4d19-b12e-c410559047c1&amp;t=3edfd96f-754c-4d19-b12e-c410559047c1&amp;width=707.828125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-553d36691615482896314c96c4d89c80" data-id="553d36691615482896314c96c4d89c80"><span><div id="553d36691615482896314c96c4d89c80" class="notion-header-anchor"></div><a class="notion-hash-link" href="#553d36691615482896314c96c4d89c80" title="触发SQL注入"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">触发SQL注入</span></span></h3><div class="notion-text notion-block-690efb46c48d419cb8e7c1ff3a65db92">app实例跑起来之后，下面是路由解析的流程</div><div class="notion-text notion-block-394b4a6eb7f248ed8cba4209af750c3f">这里以<code class="notion-inline-code">-</code>为分隔符，分割<code class="notion-inline-code">module</code>和<code class="notion-inline-code">method</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-b5ded57fd908455782f403322c6fe775"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F90ec4984-edf6-4d3a-8098-bdb8d2ea42f0%2Fimage.png?table=block&amp;id=b5ded57f-d908-4557-82f4-03322c6fe775&amp;t=b5ded57f-d908-4557-82f4-03322c6fe775&amp;width=707.96875&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-cdeebbc1376946c6857d101ab33f7f70">继续跟进<code class="notion-inline-code">setControlFile()</code>，由于app创建时传入的<code class="notion-inline-code">className</code>为<code class="notion-inline-code">router</code></div><div class="notion-text notion-block-511b568572014073b5bf3cb335f35103">所以这里会进入到子类<code class="notion-inline-code">/framework/router.class.php</code>的重载方法，也就来到了注入点。此时只需要寻找一个在WORKFLOW中存在的模块访问即可</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-deef21f585d64a9580cf48269819eff8"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fe62887b9-1ad6-40db-abc1-adfb04b9ccfb%2Fimage.png?table=block&amp;id=deef21f5-85d6-4a95-80cf-48269819eff8&amp;t=deef21f5-85d6-4a95-80cf-48269819eff8&amp;width=693&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-c275dab126ef4e2888ab38ca95f38d8c"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F8f3a2ab2-37fd-43bf-894e-b79822fd624c%2Fimage.png?table=block&amp;id=c275dab1-26ef-4e28-88ab-38ca95f38d8c&amp;t=c275dab1-26ef-4e28-88ab-38ca95f38d8c&amp;width=693&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-3c5bd2d0baa64ed8a435f5b8c6439769" data-id="3c5bd2d0baa64ed8a435f5b8c6439769"><span><div id="3c5bd2d0baa64ed8a435f5b8c6439769" class="notion-header-anchor"></div><a class="notion-hash-link" href="#3c5bd2d0baa64ed8a435f5b8c6439769" title="命令执行"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">命令执行</span></span></h3><div class="notion-text notion-block-b13dd159ff1c48d9986487fa03ceaab8">拿到后台账户权限后，可以添加定时任务。当任务类型为system时，将会调用系统命令</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-cdd26faebb424986becdc1271e13cfdb"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:637px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fba2aefa3-0ab7-40cf-9890-aa86c27c54fa%2Fimage.png?table=block&amp;id=cdd26fae-bb42-4986-becd-c1271e13cfdb&amp;t=cdd26fae-bb42-4986-becd-c1271e13cfdb&amp;width=637&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-474b7a5cffd94a1fbc3c7bc3c6eae483"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2F546d080f-3dae-4c27-b044-5beef1114eec%2Fimage.png?table=block&amp;id=474b7a5c-ffd9-4a1f-bc3c-7bc3c6eae483&amp;t=474b7a5c-ffd9-4a1f-bc3c-7bc3c6eae483&amp;width=707.984375&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-fb31ed4c05994be39d64739b2584a745">然后把执行结果存入日志了</div><div class="notion-text notion-block-e2565021545b4002aae35aac597496d3">这里的$task任务来源于<code class="notion-inline-code">zt_queue</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-8d94ff7111dd4fb7a605a16ffeee4fdc"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:341px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F447b58d6-98ee-426c-9daf-e7699c957c9f%2Fae1b9e63-4209-4613-861e-ba54c9f69abc%2Fimage.png?table=block&amp;id=8d94ff71-11dd-4fb7-a605-a16ffeee4fdc&amp;t=8d94ff71-11dd-4fb7-a605-a16ffeee4fdc&amp;width=341&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-7773dcf15eef4fa4ad0d54d19e8cbb9e" data-id="7773dcf15eef4fa4ad0d54d19e8cbb9e"><span><div id="7773dcf15eef4fa4ad0d54d19e8cbb9e" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7773dcf15eef4fa4ad0d54d19e8cbb9e" title="漏洞复现"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞复现</span></span></h2></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Apache Tomcat RCE(CVE-2025-24813)漏洞简要分析 ]]></title>
        <id>https://le1a.github.io/article/cve-2025-24813</id>
        <link href="https://le1a.github.io/article/cve-2025-24813"/>
        <updated>2025-03-10T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-1b37c0311dd680b89c85cbcfc429ce74"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1b37c0311dd6808a88d7ce00b426499c" data-id="1b37c0311dd6808a88d7ce00b426499c"><span><div id="1b37c0311dd6808a88d7ce00b426499c" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1b37c0311dd6808a88d7ce00b426499c" title="漏洞原理概述"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞原理概述</span></span></h2><div class="notion-text notion-block-1b37c0311dd6802d93f6c9e5d6ea91ef">Content-Range在Tomcat的HTTP PUT请求中主要用于实现大文件的分块传输。</div><div class="notion-text notion-block-1b37c0311dd680deb135f09b199a2b92">示例：</div><div class="notion-text notion-block-1b37c0311dd680658a65f225bf167859">该示例表明：</div><ul class="notion-list notion-list-disc notion-block-1b37c0311dd6809d8f98f32658abee4e"><li>当前传输块：0-1023字节</li></ul><ul class="notion-list notion-list-disc notion-block-1b37c0311dd6805fb852c6b2c818fa21"><li>文件总大小：10000字节</li></ul><div class="notion-text notion-block-1b37c0311dd680c6afe4fcbbf8a24d5e">在文件上传未完成的情况下，内容会被临时存储在Tomcat的工作目录：</div><div class="notion-text notion-block-1b37c0311dd680e2a094c04afc1fc179">该漏洞的核心在于不完整PUT请求上传时的文件名处理机制：</div><ul class="notion-list notion-list-disc notion-block-1b37c0311dd680debc23d1eb2a2af4c6"><li>文件路径中的分隔符/会被转换为.</li></ul><ul class="notion-list notion-list-disc notion-block-1b37c0311dd680f38db2f4c64ffb6653"><li>例如：访问<code class="notion-inline-code">/le1a/session</code>会被解析为<code class="notion-inline-code">.le1a.session</code>文件名</li></ul><div class="notion-text notion-block-1b37c0311dd68051aa4cf10f9536130d">漏洞产生的关键点：</div><ul class="notion-list notion-list-disc notion-block-1b37c0311dd6806b9241dd06bc4c1f82"><li>Tomcat的File会话存储默认路径同样位于：<code class="notion-inline-code">CATALINA_BASE/work/Catalina/localhost/ROOT</code></li></ul><ul class="notion-list notion-list-disc notion-block-1b37c0311dd68026a3a8c21509c675d1"><li>当存在反序列化利用链时，攻击者可以：</li><ul class="notion-list notion-list-disc notion-block-1b37c0311dd68026a3a8c21509c675d1"><ol start="1" class="notion-list notion-list-numbered notion-block-1b37c0311dd680ed879adbbf0fcb0b37"><li>上传包含恶意序列化数据的文件</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-1b37c0311dd680c7a958f0f9dd42449f"><li>通过设置<code class="notion-inline-code">JSESSIONID=.le1a</code>来触发漏洞</li></ol></ul></ul><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1b37c0311dd680bb9118c78af1c7011d" data-id="1b37c0311dd680bb9118c78af1c7011d"><span><div id="1b37c0311dd680bb9118c78af1c7011d" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1b37c0311dd680bb9118c78af1c7011d" title="环境配置"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">环境配置</span></span></h2><div class="notion-text notion-block-1b37c0311dd680508919fcbeb5cf1f8e">在conf/context.xml中，添加如下配置，开启File文件会话存储</div><div class="notion-text notion-block-1b37c0311dd680b2b683c62ccf602274">在conf/web.xml中，将DefaultServlet的readonly配置为false，启用写入功能</div><div class="notion-text notion-block-1b37c0311dd680eb8a03d56a0ab4ba98">将<code class="notion-inline-code">Commons Collections 3.2.1.jar</code>放入lib文件夹</div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1b37c0311dd6809e9c67e3037333d184" data-id="1b37c0311dd6809e9c67e3037333d184"><span><div id="1b37c0311dd6809e9c67e3037333d184" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1b37c0311dd6809e9c67e3037333d184" title="漏洞复现"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞复现</span></span></h2><div class="notion-text notion-block-1b37c0311dd6807d960ed417dcb8fcca">生成一个恶意的序列化文件，使用以下PoC上传，需要注意Range的分块值需要与Length保持一致，且大于当前文件的长度。</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1b37c0311dd680228435fe6c9c0cd557"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A48d9b9aa-8366-4301-bb87-573a5861cea0%3Aimage.png?table=block&amp;id=1b37c031-1dd6-8022-8435-fe6c9c0cd557&amp;t=1b37c031-1dd6-8022-8435-fe6c9c0cd557" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1b37c0311dd680548a9ad872ce91b9ab">使用以下PoC触发</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1b37c0311dd680bf9a0fcbe3d91e53e5"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A3e950a59-8d5c-4e62-987e-612ad4474f06%3A46dc526be118cde60698c858f85165fb.png?table=block&amp;id=1b37c031-1dd6-80bf-9a0f-cbe3d91e53e5&amp;t=1b37c031-1dd6-80bf-9a0f-cbe3d91e53e5" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1b37c0311dd680f6a36cc3593b885fea">​</div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[泛微ecology9 FormAction SQL注入漏洞分析]]></title>
        <id>https://le1a.github.io/article/weaver-ec9-formaction-sqli</id>
        <link href="https://le1a.github.io/article/weaver-ec9-formaction-sqli"/>
        <updated>2025-05-08T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-1ee7c0311dd68011be9acf020003ebf9"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1ee7c0311dd680d59e5afc06256804ad" data-id="1ee7c0311dd680d59e5afc06256804ad"><span><div id="1ee7c0311dd680d59e5afc06256804ad" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1ee7c0311dd680d59e5afc06256804ad" title="注入点分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">注入点分析</span></span></h3><div class="notion-text notion-block-1ee7c0311dd680f18084f26d9dac6cc7">入口点在于/mobilemode/mobile/server.jsp和/mobilemode/Action.jsp</div><div class="notion-text notion-block-1ee7c0311dd680628be5f1d59a50f444">这里反射获取invoker类，然后判断是否为BaseMobileAction的子类，然后实例化并调用execute_proxy()</div><div class="notion-text notion-block-1ee7c0311dd68029b43cf54c6050c079">遍历获取带有@ActionMapping 注解的方法，如果找到的注解中的 name 属性值与当前请求的 action 名称相匹配，就会调用该方法。</div><div class="notion-text notion-block-1ee7c0311dd680e085d7e69aef92712f">在BaseMobileAction的子类中，有一个FormAction，在它的parseDefaultValueAction中，获取了content参数的值</div><div class="notion-text notion-block-1ee7c0311dd6809db814e6593ccf13f6">在经过AES解密后</div><div class="notion-text notion-block-1ee7c0311dd680c0b9b6c0ac94c5e9da">最终执行了SQL，在这个过程中content的值是可控的。只需要知道AES的密钥即可构造恶意请求。</div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1ee7c0311dd680d6a3efea751a2bdb76" data-id="1ee7c0311dd680d6a3efea751a2bdb76"><span><div id="1ee7c0311dd680d6a3efea751a2bdb76" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1ee7c0311dd680d6a3efea751a2bdb76" title="AES密钥分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">AES密钥分析</span></span></h3><div class="notion-text notion-block-1ee7c0311dd6804484f2c6ae1d73c2f5">解密过程入口</div><div class="notion-text notion-block-1ee7c0311dd680808240d52bb2723a54">密钥获取流程</div><div class="notion-text notion-block-1ee7c0311dd68055bd49f4c97d147ceb">首先从数据库中加载配置获取所有键值对，然后加载到内存缓存和Redis缓存。然后再调用getSecurityKey()取security.key</div><div class="notion-text notion-block-1ee7c0311dd680e0976edf6982ea13f2">如果内存缓存和Redis缓存都为空时，才会从配置文件中获取security.key，并更新数据库，然后调用setConfig()同步更新内存和Redis缓存。</div><div class="notion-text notion-block-1ee7c0311dd680208fe0ee83236a3b96"></div><div class="notion-text notion-block-1ee7c0311dd68000b15edf24fab45124"></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1ee7c0311dd680bd9428ea4228621a5b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A623cd8eb-4dbf-4f4f-a94f-dd0733fcfa8d%3Ac425d438-347b-4446-a138-4e9981e03150.png?table=block&amp;id=1ee7c031-1dd6-80bd-9428-ea4228621a5b&amp;t=1ee7c031-1dd6-80bd-9428-ea4228621a5b" alt="notion image" loading="lazy" decoding="async"/></div></figure><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1ee7c0311dd68084b992db3daa0e36c2" data-id="1ee7c0311dd68084b992db3daa0e36c2"><span><div id="1ee7c0311dd68084b992db3daa0e36c2" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1ee7c0311dd68084b992db3daa0e36c2" title="数据库中的security.key从何而来？"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">数据库中的security.key从何而来？</span></span></h3><div class="notion-text notion-block-1ee7c0311dd680f0a3e2febb6c36138d">在SecurityRuleInitMobileConfig中，对于security.key进行了初始化</div><ol start="1" class="notion-list notion-list-numbered notion-block-1ee7c0311dd680b9ac2ee247da788b1e"><li>首先查询数据库中是否存在security.key</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-1ee7c0311dd680139995cacf60e3bb3c"><li>如果存在且有效，则标记数据库初始化成功</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-1ee7c0311dd680bf87c1d011eebb0f41"><li>如果不存在或为空：</li><ol class="notion-list notion-list-numbered notion-block-1ee7c0311dd680bf87c1d011eebb0f41"><li>生成新的随机UUID的前16位作为密钥</li><li>更新数据库中的值</li><li>记录初始化结果</li></ol></ol><ol start="4" class="notion-list notion-list-numbered notion-block-1ee7c0311dd680528bc2c4bf6aec3cb5"><li>然后检查配置文件中是否已有密钥</li></ol><ol start="5" class="notion-list notion-list-numbered notion-block-1ee7c0311dd680c78a9dce14fb52f2ce"><li>如果配置文件中没有密钥：</li><ol class="notion-list notion-list-numbered notion-block-1ee7c0311dd680c78a9dce14fb52f2ce"><li>将生成的随机密钥写入配置文件</li><li>记录配置文件初始化结果</li></ol></ol><blockquote class="notion-quote notion-block-1ee7c0311dd680ac83c2eeaa7ff244bc"><div>这其实有概率导致数据库和配置文件的密钥不一致</div></blockquote><div class="notion-text notion-block-1ee7c0311dd68005a53fddc2fc250e73"></div><div class="notion-text notion-block-1ee7c0311dd680abb975d22ddb8c0e85"></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1ee7c0311dd68081a909d8e1eed80791"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Acd8e7893-94af-467b-a7bf-1382dbac7c71%3A1c7d7581-f6ae-4658-b71b-341714e4a542.png?table=block&amp;id=1ee7c031-1dd6-8081-a909-d8e1eed80791&amp;t=1ee7c031-1dd6-8081-a909-d8e1eed80791" alt="notion image" loading="lazy" decoding="async"/></div></figure><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1ee7c0311dd680e8a627ff0926ae4bb1" data-id="1ee7c0311dd680e8a627ff0926ae4bb1"><span><div id="1ee7c0311dd680e8a627ff0926ae4bb1" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1ee7c0311dd680e8a627ff0926ae4bb1" title="漏洞复现"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞复现</span></span></h3><div class="notion-text notion-block-1ee7c0311dd68013b664d4396f558ed4">读取数据库中的密钥：</div><div class="notion-text notion-block-1ee7c0311dd680a19437de723cc88a5c"></div><div class="notion-text notion-block-1ee7c0311dd680bc8d82e8473085fc4e"></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1ee7c0311dd6807795f1cc9fc767bd1b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:677px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Ad1c11636-0b72-4d2e-94e8-1952b8a34698%3A99daac63-df5e-4538-b1b3-3cc13f5edb8a.png?table=block&amp;id=1ee7c031-1dd6-8077-95f1-cc9fc767bd1b&amp;t=1ee7c031-1dd6-8077-95f1-cc9fc767bd1b" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1ee7c0311dd680c9806ed9a185b6b4ee">然后使用以下脚本构造加密content，脚本来自于@lipuhua</div><div class="notion-text notion-block-1ee7c0311dd680408d4dcb29febbdcf9"></div><div class="notion-text notion-block-1ee7c0311dd680349647c964cb0b116d"></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-1ee7c0311dd6808889fac82061f51255"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A9839b2a6-dba2-4380-bd39-359663dcedd1%3A85a2bf7d-924d-4dca-bb01-3b256f509360.png?table=block&amp;id=1ee7c031-1dd6-8088-89fa-c82061f51255&amp;t=1ee7c031-1dd6-8088-89fa-c82061f51255" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1ee7c0311dd680ce890cfa6b7c05440b">感觉是有点鸡肋在的....security.key不是硬编码，需要结合文件读取才能利用。</div><div class="notion-blank notion-block-1ee7c0311dd680c19272eb2d412e5ff9"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[泛微ecology9 getdata.jsp 远程代码执行漏洞分析]]></title>
        <id>https://le1a.github.io/article/2157c031-1dd6-8045-9dbc-ef59b391bfe6</id>
        <link href="https://le1a.github.io/article/2157c031-1dd6-8045-9dbc-ef59b391bfe6"/>
        <updated>2025-06-16T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-2157c0311dd680459dbcef59b391bfe6"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-2157c0311dd680cb925ff8edd19b2fa6" data-id="2157c0311dd680cb925ff8edd19b2fa6"><span><div id="2157c0311dd680cb925ff8edd19b2fa6" class="notion-header-anchor"></div><a class="notion-hash-link" href="#2157c0311dd680cb925ff8edd19b2fa6" title="漏洞分析"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">漏洞分析</span></span></h3><div class="notion-text notion-block-2157c0311dd68061aedbc9d851398d30">漏洞点位于：/js/hrm/getdata.jsp</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd6809f877fcf5aaa10eb9c"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A41ab0da6-0880-4882-b3fb-23de42b38a7f%3Aimage-20250514142114-f3qna3m.png?table=block&amp;id=2157c031-1dd6-809f-877f-cf5aaa10eb9c&amp;t=2157c031-1dd6-809f-877f-cf5aaa10eb9c" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd680deb3b9c35fd3a76711"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3Aa9ffa7db-208c-48d9-8b81-8283c5741f36%3Aimage-20250514145017-xjdfncl.png?table=block&amp;id=2157c031-1dd6-80de-b3b9-c35fd3a76711&amp;t=2157c031-1dd6-80de-b3b9-c35fd3a76711" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd6805c9b79fc87830d3a08">该代码接收 cmd 参数，依据其不同取值执行相应处理逻辑。当 cmd 取值不匹配上述特定情况时，会调用 <code class="notion-inline-code">result.append(weaver.hrm.common.AjaxManager.getData(request, application));</code></div><div class="notion-text notion-block-2157c0311dd6801cbc95ea3ee3a10834">将cmd的值进行URL解码后，传入<code class="notion-inline-code">proc(var0, var3, var1, var2);</code></div><div class="notion-text notion-block-2157c0311dd68068af42f05dc3c93b24">当cmd参数为savect时，从request中获取arg0参数的值，然后传入<code class="notion-inline-code">HrmChartSet.get();</code></div><div class="notion-text notion-block-2157c0311dd680f8bd6fe2812346b939">继续跟进至实现方法<code class="notion-inline-code">HrmChartSetDao#get()</code></div><div class="notion-text notion-block-2157c0311dd680bfbc22dd72a7ffabaa">继续跟进至<code class="notion-inline-code">HrmChartSetDao#find()</code></div><div class="notion-text notion-block-2157c0311dd680eba83dc77e8fe278cf">这里把最开始的<code class="notion-inline-code">arg0</code>拼接到了SQL语句当中，造成SQL注入漏洞。</div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-2157c0311dd68001a15eecfdea04d0d0" data-id="2157c0311dd68001a15eecfdea04d0d0"><span><div id="2157c0311dd68001a15eecfdea04d0d0" class="notion-header-anchor"></div><a class="notion-hash-link" href="#2157c0311dd68001a15eecfdea04d0d0" title="绕过参数安全限制"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">绕过参数安全限制</span></span></h3><div class="notion-text notion-block-2157c0311dd680e79c05d79306a8831e">该路径有安全校验规则，具体代码在<code class="notion-inline-code">weaver.security.rules.ruleImp.SecurityRuleGetData#validate()</code>中，限制了<code class="notion-inline-code">arg0</code>参数</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd680d7af00c5c4f42e2eda"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A9c7d0040-3376-488d-8c07-b872a63cc0e9%3Aimage-20250514173629-zx53lp0.png?table=block&amp;id=2157c031-1dd6-80d7-af00-c5c4f42e2eda&amp;t=2157c031-1dd6-80d7-af00-c5c4f42e2eda" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd6804a9a19d9cb7439658c">不允许出现单引号和百分号。这里可以使用 CONCAT 和 CHAR 构建</div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-2157c0311dd6804a9264e9cf37fb9ecb" data-id="2157c0311dd6804a9264e9cf37fb9ecb"><span><div id="2157c0311dd6804a9264e9cf37fb9ecb" class="notion-header-anchor"></div><a class="notion-hash-link" href="#2157c0311dd6804a9264e9cf37fb9ecb" title="绕过Rasp限制"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">绕过Rasp限制</span></span></h3><div class="notion-text notion-block-2157c0311dd680e49f3bc3885403e021">新版本泛微自带Rasp，针对SQL注入的监测点在<code class="notion-inline-code">weaver.security.agentRules.rule.sqlCheck.SqlInjectionRule#doClean()</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd680768b09d148abfd49c5"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A6f75956c-335f-4448-8b12-d886a9837949%3Aimage-20250514174905-jyzgxdh.png?table=block&amp;id=2157c031-1dd6-8076-8b09-d148abfd49c5&amp;t=2157c031-1dd6-8076-8b09-d148abfd49c5" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd680f790a5f78e781f077f"><code class="notion-inline-code">isStrictCheck</code>为true，代表高防，默认情况下是开启高防状态的</div><div class="notion-text notion-block-2157c0311dd6808986aaf6a31a07d57c">继续跟进<code class="notion-inline-code">parseSqlNewLevelHight</code></div><div class="notion-text notion-block-2157c0311dd68043a308d3ca9bb146d0">首先进入语义检测<code class="notion-inline-code">parseSqlNew</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd6800abe6af7ad558c77dc"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A653a10ac-05a0-4bba-a54a-6398749c8bc4%3Aimage-20250514175625-i5xzssh.png?table=block&amp;id=2157c031-1dd6-800a-be6a-f7ad558c77dc&amp;t=2157c031-1dd6-800a-be6a-f7ad558c77dc" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd680e1be86ecf77810df1d">跟进<code class="notion-inline-code">parseDuridSql</code></div><div class="notion-text notion-block-2157c0311dd680f0a10df00243aa4b5e">如果SQL语句不是以set或者declare开头，就无法通过检测。</div><div class="notion-text notion-block-2157c0311dd680c28b17dbf5791fde78">但这里用到的是druid进行语义解析。Druid 的语义解析流程可概括为：</div><blockquote class="notion-quote notion-block-2157c0311dd680daad14f3354931122b"><div>SQL文本 → 词法分析 → Token序列 → 语法分析 → AST → 语义验证 → 安全检测</div></blockquote><div class="notion-text notion-block-2157c0311dd6801da6efe640a608d467">但是Druid存在token解析不全的问题。</div><div class="notion-text notion-block-2157c0311dd6806ba333f16c1bed56a4">通过这个demo可以清晰地看到，出现<code class="notion-inline-code">RECONFIGURE</code>关键字的时候，会抛出<code class="notion-inline-code">ParserException</code>异常。</div><div class="notion-text notion-block-2157c0311dd680d88660ec7d8da05132"><code class="notion-inline-code">由于Throwable</code>是所有异常和错误的超类，所以这里就绕过了语义分析，进入catch，继续调用<code class="notion-inline-code">parseCcjsSqlNew</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd680419224e1936de262ad"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A2c0c7b26-a6f2-4c77-863a-0a42fff88be9%3Aimage-20250514181534-rgqnpes.png?table=block&amp;id=2157c031-1dd6-8041-9224-e1936de262ad&amp;t=2157c031-1dd6-8041-9224-e1936de262ad" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd6802faa93fe182bc04b5f">这里也没有对<code class="notion-inline-code">RECONFIGURE</code>做处理，返回<code class="notion-inline-code">RuntimeException</code>异常。回到<code class="notion-inline-code">parseSqlNewLevelHight</code>调用<code class="notion-inline-code">filterSqlWhite</code></div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2157c0311dd680539128d88c6269ec45"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/attachment%3A95a0ea93-e05e-4748-a10a-897d1decbdf1%3Aimage-20250514182544-vxc40rh.png?table=block&amp;id=2157c031-1dd6-8053-9128-d88c6269ec45&amp;t=2157c031-1dd6-8053-9128-d88c6269ec45" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2157c0311dd6803a8934c4e1d7741bd2">总共5种情况可可以返回true：</div><ul class="notion-list notion-list-disc notion-block-2157c0311dd680818555d1feb6671ed8"><li>纯标识符（无 SQL 关键字）</li></ul><ul class="notion-list notion-list-disc notion-block-2157c0311dd68078bfa0ff43745a9276"><li>以 <code class="notion-inline-code">select</code>开头（小写且有空格），同时包含 <code class="notion-inline-code">translate(</code> <b>或</b> <code class="notion-inline-code">left hash join</code>。</li></ul><ul class="notion-list notion-list-disc notion-block-2157c0311dd680f6b8c9c72b9b0b3204"><li>SQL 语句以 onlySqlWhitePrefix 列表中的任意字符串（如 SET 、DECLARE ）开头。</li></ul><ul class="notion-list notion-list-disc notion-block-2157c0311dd68074b544fb4a0ca03829"><li>以 <code class="notion-inline-code">sqlWhitePrefix</code> 列表中的任意字符串（如 <code class="notion-inline-code">SELECT</code>、<code class="notion-inline-code">UPDATE</code>）开头（小写），同时包含 <code class="notion-inline-code">collate</code>和 <code class="notion-inline-code">chinese_prc_cs_a</code>（区分大小写排序规则），不包含分号。</li></ul><ul class="notion-list notion-list-disc notion-block-2157c0311dd6801eb609f054ca74909d"><li>以 <code class="notion-inline-code">set identity_insert</code> 开头（小写），以 <code class="notion-inline-code">on</code> 或 <code class="notion-inline-code">off</code> 结尾，按空格分割后恰好为 4 个部分（如 set identity_insert table_name on）</li></ul><div class="notion-text notion-block-2157c0311dd6804e884ecb8f1953b70b">最简单的就是第二种了，所以构造arg0的值为：</div></main></div>]]></content>
    </entry>
</feed>